<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<body>
<div class="container">
    <div class="col-6">
       
        <h4>${myRoom}</h4>
<%--         <h4>${myRoomList}</h4> --%>
<%--         <h4>${myRoomList}</h4> --%>
    </div>
    <div>
        <div id="msgArea" class="col"></div>
        <div class="col-6">
            <div class="input-group mb-3">
                <input type="text" id="msg" class="form-control">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="submit" id="button-send">전송</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6"></div>
<%-- 				var username = ${#authentication.principal.username}; --%>
</div>
<script type="text/javascript">
// 메세지 보내기
$(document).ready(function() {
	
	var myRoom = ${myList};
	console.log("myRoom : ", myRoom);
	let roomStr = JSON.stringify(myRoom);
	console.log(roomStr[0]);
	// 배열의 첫 번째 요소를 가져옵니다.
	let room = roomStr[0];
	roomNo = room.roomNo;
	console.log("roomNo:", myRoom[0]);

// 	var roomNo = myRoom["roomNo"];
	
	console.log("roomNo: ", roomNo);


    var sockJs = new SockJS("/stomp/chat");
    var stomp = Stomp.over(sockJs);

    stomp.connect({}, function() {
        console.log("STOMP Connection");

        stomp.subscribe("/sub/chat/room/" + roomNo, function(chat) {
            var content = JSON.parse(chat.body);
            console.log("chat" , chat);
            console.log("content" , content);
            var writer = content.userId;
            var message = content.msgCont;
            var str = '';

            if (writer === userId) {
                str += "<div class='col-6'>";
                str += "<div class='alert alert-secondary'>";
                str += "<b>" + writer + " : " + message + "</b>";
                str += "</div></div>";
            } else {
            	console.log("aa" , userId);
                str += "<div class='col-6'>";
                str += "<div class='alert alert-warning'>";
                str += "<b>" + writer + " : " + message + "</b>";
                str += "</div></div>";
            }

            $("#msgArea").append(str);
        });

        stomp.send('/pub/chat/enter', {}, JSON.stringify({
        	roomNo: roomNo, writer: userId
        	
        	}))
    });
    $("#msg").keydown(function(key) {
        var msg = document.getElementById("msg");

        if (key.keyCode == 13) {
            stomp.send('/pub/chat/message', {},
                JSON.stringify({ roomNo: roomNo, msgCont: msg.value, writer: userId })
            );
            console.log('Enter');
            msg.value = '';
        }

    });
});
	
// 	$("#button-send").on("click", function(e){
	 
// 	var msg = document.getElementById("msg");
	
// 	console.log("작성자 "+username + ":" +"메세지 내용"+ msg.value);
// 	console.log(username + ":" + msg.value);
// 	stomp.send('/pub/chat/message', {}, JSON.stringify({roomNo: roomNo, message: msg.value, writer: username}));
// 	});
// 	    msg.value = '';
//      });
// });
</script>
</body>
</html>