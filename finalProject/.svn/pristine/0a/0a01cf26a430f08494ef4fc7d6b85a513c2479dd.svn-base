package kr.or.ddit.member.join.controller;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Map;
import java.util.Random;
import java.util.UUID;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.apache.commons.collections.map.HashedMap;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import kr.or.ddit.member.join.service.MemberJoinService;
import kr.or.ddit.vo.AdresVO;
import kr.or.ddit.vo.UsersVO;
import kr.or.ddit.vo.MberVO;
import lombok.extern.slf4j.Slf4j;

@Controller
@Slf4j
@RequestMapping("/member")
public class MemberJoinController {
	@Autowired
	MemberJoinService memberJoinService;
	
	@GetMapping("/memberJoin")
	public String memberJoin() {
		return "member/memberJoin";
	}
	@GetMapping("/memberLogin")
	public String memberLogin() {
		return "member/memberLogin";
	}
	@GetMapping("/joinSelect")
	public String joinSelect() {
		return "joinSelect";
	}
	
	//이메일 중복확인
	@ResponseBody
	@GetMapping("/emailCk")
	public int emailCk(String email) {
		int result = this.memberJoinService.emailCk(email);
		
		return result;
	}
	
	//아이디 중복확인
	@ResponseBody
	@GetMapping("/idCk")
	public int idCk(String userId) {
		int result = this.memberJoinService.idCk(userId);
		
		return result;
	}
	
	//닉네임 중복 확인
	@ResponseBody
	@GetMapping("/ncnmCk")
	public int ncnmCk(String userNcnm) {
		int result = this.memberJoinService.ncnmCk(userNcnm);
		
		return result;
	}
	
	//휴대폰 본인인증
	@ResponseBody
	@PostMapping("/check/sendSMS")
    public String sendSMS(String mberMbtlnum) {
        Random rand  = new Random();
        String numStr = "";
        for(int i=0; i < 6; i++) {
            String ran = Integer.toString(rand.nextInt(10));
            numStr+=ran;
        }
        log.info("인증번호 : " + numStr);
//        this.memberJoinService.certifiedPhoneNumber(mberMbtlnum,numStr);
        return numStr;
    }
	
	//회원가입
	@PostMapping("/memberInsert")
	public String memberInsert(UsersVO usersVO, MberVO mberVO, AdresVO adresVO) {
		log.info("userVO : " + usersVO);
		log.info("mberVO : " + mberVO);
		log.info("adresVO : " + adresVO);
		Map<String, Object> map = new HashedMap();
		
		//프로필사진 업로드 처리
		MultipartFile multipartFile = mberVO.getUploadFile();
//		log.info("multipartFile 처음 : " + multipartFile);
		String uploadFolder = "c:\\upload";
		File uploadPath = new File(uploadFolder, getFolder());
		if(!uploadPath.exists()) {
			uploadPath.mkdirs();
		}
		String uploadFileName = multipartFile.getOriginalFilename();
//		log.info("uploadFileName 전 : " + uploadFileName);
		UUID uuid = UUID.randomUUID();
		uploadFileName = uuid.toString() + "_" + uploadFileName;
//		log.info("uploadFileName 후 : " + uploadFileName);
		File saveFile = new File(uploadPath, uploadFileName);
		try {
			multipartFile.transferTo(saveFile);
		} catch (IllegalStateException | IOException e) {
			log.info(e.getMessage());
		}
		log.info("saveFile : " + saveFile);
		String url = "/" + getFolder().replace("\\", "/") + "/" + uploadFileName;
		log.info("url : " + url);
		map.put("userId", usersVO.getUserId());
		map.put("userNcnm", usersVO.getUserNcnm());
		map.put("mberMbtlnum", mberVO.getMberMbtlnum());
		map.put("sexdstnTy", mberVO.getSexdstnTy());
		map.put("email", mberVO.getEmail());
		map.put("mberProflPhoto", url);
		map.put("userNm", usersVO.getUserNm());
		map.put("userPassword", usersVO.getUserPassword());
		map.put("adres", adresVO.getAdres());
		map.put("detailAdres", adresVO.getDetailAdres());
		map.put("zip", adresVO.getZip());
		
		int result = this.memberJoinService.memberInsert(map);
		log.info("회원가입 여부 : " + result);
		
		return "welcome";
	}
	
	//회원 로그인
	@ResponseBody
	@PostMapping("/memberLogin")
	public UsersVO memberLogin(String userId, String userPassword, HttpServletRequest request) {
		Map<String, Object> userMap = new HashedMap();
		userMap.put("userId", userId);
		userMap.put("userPassword", userPassword);
		log.info("로그인 전 map : " + userMap);
		
		UsersVO usersVO = this.memberJoinService.memberLogin(userMap);
		log.info("로그인 후 vo : " + usersVO);
		
		HttpSession session = request.getSession();
		if(usersVO != null) {
			session.setAttribute("memSession", usersVO);
		}else {
			session.setAttribute("memSession", null);
		}
		
		return usersVO;
	}
	
	@GetMapping("/memberLogout")
	public String memberLogout(HttpSession session) {
		session.removeAttribute("memSession");
		
		return "main";
	}
	
	public String getFolder() {
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		Date date = new Date();
		String str = sdf.format(date);
		log.info(str);
		return str.replace("-", File.separator);
	}

}
