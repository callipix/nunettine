<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<link rel="stylesheet" href="/resources/chat/chatFFF/bundle.css">
<link rel="stylesheet" href="/resources/chat/chatFFF/app.css">
<script	src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<style>
    #hiddenElement {
        display: none;
    }
</style>
<script>
// $(document).ready(function() {
//     // 우선 체크 버튼에 클릭 이벤트 핸들러를 추가합니다.
//     $('a.check-button').on('click', function(event) {
//         check(event); // check 함수를 호출합니다.
//     });
// });
$(document).ready(function() {
	    $.ajax({
	        url: "/todayMeeting/listAjax",
	        type: "post",
	        contentType: "application/json;",
	        dataType: "json",
	        success: function(result) {
	            var roomList = result;
	            var allRoomContent = '';
	            $.each(roomList, function(index, TdmtngVO) {
	                allRoomContent += '<div class="tyn-media-group">';
	                allRoomContent += '<div class="tyn-media tyn-size-lg">';
	                allRoomContent += '</div>';
	                allRoomContent += '<div class="tyn-media-col">';
	                allRoomContent += '<h6 class="name"><a href="#" class="roomLink" data-tdmtngNo="' + TdmtngVO.tdmtngNo + '">' + TdmtngVO.tdmtngNm + '</a></h6>';
	                allRoomContent += '<p class="content">@' + TdmtngVO.userId + '</p>';
	                allRoomContent += '</div>';
	                allRoomContent += '</div>';
	            });
	            $('#roomWrap').html(allRoomContent);
	        },
	        error: function(xhr, status, error) {
	            console.error('Error fetching room list:', status, error);
	        }
	    });
});
$(document).on('click', '.roomLink', function(e) {
    e.preventDefault(); // 기본 동작 방지
    var tdmtngNo = $(this).attr('data-tdmtngNo'); // 클릭한 방의 tdmtngNo 가져오기
    
    $.ajax({
        url: "/todayMeeting/join",
        type: "post",
        data: { tdmtngNo: tdmtngNo }, // 객체 형태로 전달
        
        success: function(pageHtml) {
            console.log("asdas : ");
            
            
            // 가져온 페이지 HTML을 원하는 위치에 추가합니다.
            $('#roomWrap').html(pageHtml);
        },
        error: function(xhr, status, error) {
            console.error('Error fetching room page:', status, error);
        }
    });
});
</script>



<div class="tyn-quick-chat" id="tynQuickChat">
            <button class="tyn-quick-chat-toggle js-toggle-quick">
                <svg viewBox="0 0 43 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M37.2654 14.793C37.2654 14.793 45.0771 20.3653 41.9525 29.5311C41.9525 29.5311 41.3796 31.1976 39.0361 34.4264L42.4732 37.9677C42.4732 37.9677 43.3065 39.478 41.5879 39.9987H24.9229C24.9229 39.9987 19.611 40.155 14.8198 36.9782C14.8198 36.9782 12.1638 35.2076 9.76825 31.9787L18.6215 32.0308C18.6215 32.0308 24.298 31.9787 29.7662 28.3333C35.2344 24.6878 37.4217 18.6988 37.2654 14.793Z" fill="#60A5FA"></path>
                    <path d="M34.5053 12.814C32.2659 1.04441 19.3506 0.0549276 19.3506 0.0549276C8.31004 -0.674164 3.31055 6.09597 3.31055 6.09597C-4.24076 15.2617 3.6751 23.6983 3.6751 23.6983C3.6751 23.6983 2.99808 24.6357 0.862884 26.5105C-1.27231 28.3854 1.22743 29.3748 1.22743 29.3748H17.3404C23.4543 28.7499 25.9124 27.3959 25.9124 27.3959C36.328 22.0318 34.5053 12.814 34.5053 12.814ZM19.9963 18.7301H9.16412C8.41419 18.7301 7.81009 18.126 7.81009 17.3761C7.81009 16.6261 8.41419 16.022 9.16412 16.022H19.9963C20.7463 16.022 21.3504 16.6261 21.3504 17.3761C21.3504 18.126 20.7358 18.7301 19.9963 18.7301ZM25.3708 13.314H9.12245C8.37253 13.314 7.76843 12.7099 7.76843 11.96C7.76843 11.21 8.37253 10.6059 9.12245 10.6059H25.3708C26.1207 10.6059 26.7248 11.21 26.7248 11.96C26.7248 12.7099 26.1103 13.314 25.3708 13.314Z" fill="#2563EB">
                    </path>
                </svg>
                <span class="badge bg-primary top-0 end-0 position-absolzute rounded-pill">2</span>
            </button>
			            
            <div class="tyn-quick-chat-box">
           <button id="hideButton" style="position: relative; overflow: hidden;">
			    <svg id="icon" xmlns="http://www.w3.org/2000/svg" width="4em" height="4em" viewBox="0 0 24 24" style="position: absolute; top: 0; left: 0;">
			        <path fill="currentColor" d="M19 8l-4 4h3c0 3.31-2.69 6-6 6c-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6c1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4l4-4H6z"><animateTransform attributeName="transform" attributeType="XML" dur="5s" from="360 12 12" repeatCount="indefinite" to="0 12 12" type="rotate"/></path>
			    </svg>
			</button>


            <div id="visible" class="hidden">
            
<div id="bottomContent">
	<div id="roomWrap">
	    <div id="theme-settings-sub"></div>
		    <div id="contentCover">
<!--             <a href="javascript:void(0);" onclick="check(event)">우선 체크</a> -->
			<a href="javascript:void(0);" class="check-button">우선 체크</a>
            <div id="roomHeader">전체리스트</div>
            <c:forEach var="TdmtngVO" items="${allRoomList}" varStatus="stat">
                <a href="javascript:void(0);" onclick="allRoomList(event, '${TdmtngVO.tdmtngNo}')">${TdmtngVO.tdmtngNm}</a>
                <br>
            </c:forEach>
            <div id="roomWrap">
                <div id="myroomlist">
                    <div id="roomHeader">내방목록</div>
                    <ul>
                        <c:forEach var="myRoomVO" items="${myRoomList}" varStatus="stat">
                            <br>
                            <a href="javascript:void(0);" onclick="join('${myRoomVO.roomNo}')">${myRoomVO.roomName}</a>
                        </c:forEach>
                    </ul>
                </div>
            </div>
    </div>
</div>

			<button id="hideButton" style="position: relative; overflow: hidden;">
    <svg id="icon" xmlns="http://www.w3.org/2000/svg" width="4em" height="4em" viewBox="0 0 24 24" style="position: absolute; top: 0; left: 0;">
        <path fill="currentColor" d="M19 8l-4 4h3c0 3.31-2.69 6-6 6c-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6c1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4l4-4H6z"><animateTransform attributeName="transform" attributeType="XML" dur="5s" from="360 12 12" repeatCount="indefinite" to="0 12 12" type="rotate"/></path>
    </svg>
</button>
			</div>

            
            </div>
                
			<div id ="hiddenElement" class="hidden">
			<!--  -->
<script type="text/javascript">
$(document).ready(function(){
	
	var myRoom = ${myList};
 	var roomMessageJson = ${roomMessageJson};

 	var roomNo = myRoom["roomNo"];
	var userId = myRoom["userId"];

	var sockJs = new SockJS("/stomp/chat");
 	var stomp = Stomp.over(sockJs);
	
 	stomp.connect({}, function() {
	console.log("STOMP Connection");
	
	stomp.subscribe("/sub/chat/room/" + roomNo, function(chat) {
		
	    var content = JSON.parse(chat.body);
	    var roomNo  = content.roomNo;
	    var message = content.msgCont;
	    var writer = content.userId;
	    var date = content.msgSendDate;
	    
	    let str = '';
	    
		console.log("content : " , content);
		
	    if (writer === userId) {
	        str += "<div class='col-6'>";
	        str += "<div class='alert alert-secondary'>";
	        str += "<b>" + writer + " : " + message + "</b>";
	        str += "</div></div>";
	    } else {
// 	    	console.log("유저아이디와 다를때" , userId);
	        str += "<div class='col-6'>";
	        str += "<div class='alert alert-warning'>";
	        str += "<b>" + writer + " : " + message + "</b>";
	        str += "</div></div>";
	    }
	    $("#msgArea").append(str);
	});
	console.log("테스트" , roomNo)
	  stomp.send('/pub/chat/enter', {},
			  JSON.stringify({ roomNo: roomNo, userId:userId})
			  );
	});
	$("#msg").keydown(function(key) {
	  var msg = document.getElementById("msg");
	  
	  var date = getTime();
	  
	  if (key.keyCode == 13) {
	      stomp.send('/pub/chat/message', {},
	          JSON.stringify({ roomNo: roomNo, msgCont: msg.value, msgSendDate: date , userId:userId , msgCheck:"T" })
	      );
	      console.log('Enter');
	      msg.value = '';
	  }
	
	});
});
</script>
<div id="msgArea1" class="col"></div>
    <div id="msgArea2" class="col" style="width: 50px;"></div>
    
<!--     <div id="chatMessages"> -->
    <script type="text/javascript">
        // JavaScript 코드 시작
		var myRoom = ${myList};
		var roomMessageJson = ${roomMessageJson};
		let isMonth = false;		// 이전 날짜 출력 여부
		let firstDate = roomMessageJson[0]["msgSendDate"].substring(0,10);
		let previousDate = null;
        // 채팅 메시지를 출력하는 함수
        function displayChatMessages() {
        	
            for (let i = 0; i < roomMessageJson.length; i++) {
                var msgData = {
                	msgNo:roomMessageJson[i]["msgNo"],
                    msgSendDate: roomMessageJson[i]["msgSendDate"],
                    msgCont: roomMessageJson[i]["msgCont"],
                    userId: roomMessageJson[i]["userId"],
                    roomNo: roomMessageJson[i]["roomNo"]
                };
                
				var str = '';
				var str2 = '';

				let currentDate = msgData.msgSendDate.substring(0,10).trim();
				if(currentDate != previousDate){
					str += "<h4 class='col-6 text-center'>"+currentDate+"</h4>";
					previousDate = currentDate;
				};
				$("msgArea1").append(str);
				
				var newChatMessageDiv = document.createElement("div");

				if (msgData.userId === myRoom.userId) {
               	// 내가 보낸 내역
	               	str += "<div class='col-6 text-right chat-message'>";
	               	str += "<div class='alert alert-secondary style=width:50px;'>";
	               	str += "<b>"+"roomNo : "+msgData.roomNo+"<br>";
	               	str += "msgNo : "+msgData.msgNo+"<br>"
	               	str += "sendDate : " + msgData.msgSendDate.substring(10 ,16)+"<br>";
                	str += "메세지내용 : " +msgData.msgCont;
	               	str += "</div></div>"
                } else {
                	str += "<div class='col-6 text-left chat-message'>";
                	str += "<div class='alert alert-warning style=width:50px;'>";
                	str += "<b>"+"roomNo : "+msgData.roomNo+"<br>";
                	str += "msgNo : "+msgData.msgNo+"<br>"
                	str += "sendDate : " +msgData.msgSendDate.substring(10 ,16)+"<br>";
                	str += "Id : "+ msgData.userId+"<br>"
                	str += "메세지내용 : " +msgData.msgCont;
                	str += "</div></div>";
                }
				$("#msgArea1").append(str);
				$("#theme-settings-sub").append(str);
            }
        }
        // 페이지 로드 시 채팅 메시지 출력
        displayChatMessages();
        // JavaScript 코드 끝
</script>
			<!--  -->
                <div class="tyn-quick-chat-head">
                    <div class="tyn-media-group">
                        <div class="tyn-media tyn-size-rg">
                            <img src="images/avatar/1.jpg" alt="">
                        </div>
                        <div class="tyn-media-col">
                            <div class="tyn-media-row">
                                <h6 class="name">Jasmine Thompson</h6>
                            </div>
                            <div class="tyn-media-row has-dot-sap">
                                <span class="meta">Active</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tyn-quick-chat-reply js-scroll-to-end" data-simplebar="init"><div class="simplebar-wrapper" style="margin: 0px;"><div class="simplebar-height-auto-observer-wrapper"><div class="simplebar-height-auto-observer"></div></div><div class="simplebar-mask"><div class="simplebar-offset" style="right: 0px; bottom: 0px;"><div class="simplebar-content-wrapper" tabindex="0" role="region" aria-label="scrollable content" style="height: 100%; overflow: hidden scroll;"><div class="simplebar-content" style="padding: 0px;">
                    <div class="tyn-reply tyn-reply-quick" id="tynQuickReply">
                        <div class="tyn-reply-item incoming">
                            <div class="tyn-reply-avatar">
                                <div class="tyn-media tyn-size-md tyn-circle">
                                    <img src="images/avatar/2.jpg" alt="">
                                </div>
                            </div>
                        </div><!-- .tyn-reply-item -->
                        <div class="tyn-reply-separator">May 10, 2022, 11:14 AM</div>
                    </div><!-- .tyn-reply -->
                </div>
                </div></div></div><div class="simplebar-placeholder" style="width: auto; height: 502px;"></div></div><div class="simplebar-track simplebar-horizontal" style="visibility: hidden;">
                <div class="simplebar-scrollbar" style="width: 0px; display: none;"></div></div><div class="simplebar-track simplebar-vertical" style="visibility: visible;"><div class="simplebar-scrollbar" style="height: 263px; transform: translate3d(0px, 101px, 0px); display: block;"></div></div></div>
                <div class="tyn-quick-chat-form">
                    <div class="tyn-chat-form-input bg-light" id="tynQuickChatInput" contenteditable=""></div>
                    <ul class="tyn-list-inline me-n2 my-1">
                        <li><button class="btn btn-icon btn-white btn-sm btn-pill">
                                <!-- send-fill -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"></path>
                                </svg>
                            </button></li>
                    </ul>
                </div>
                <button class="btn btn-danger btn-sm btn-icon top-0 end-0 position-absolute rounded-pill translate-middle js-toggle-quick">
                    <!-- x-lg -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"></path>
                    </svg>
                </button>
            </div>
            </div>
	</div>
	<script>
    // 버튼 요소 참조
    const hideButton = document.getElementById('hideButton');

    // 숨겨질 요소 참조
    const hiddenElement = document.getElementById('hiddenElement');

    // 클릭 이벤트 리스너 추가
    hideButton.addEventListener('click', function() {
        // 숨겨질 요소를 숨깁니다.
       if (hiddenElement.style.display === 'none') {
    	   visible.style.display = 'none'; // 숨겨진 경우 보이게 함
            hiddenElement.style.display = 'block'; // 숨겨진 경우 보이게 함
        } else {
    	   visible.style.display = 'block'; // 숨겨진 경우 보이게 함
            hiddenElement.style.display = 'none'; // 보이는 경우 숨김
        }
    });
	</script>
<script src="/resources/chat/chatFFF/bundle.js"></script>
<script src="/resources/chat/chatFFF/app.js"></script>