<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.pro.proSearch.mapper.SearchProMapper">

	<resultMap type="proVO" id="proMap">
		<result property="proId" column="PRO_ID"/>
		<result property="proProflPhoto" column="PRO_PROFL_PHOTO"/>
		<result property="spcltyRealmCode" column="SPCLTY_REALM_CODE"/>
		<collection property="proflVOList" ofType="proVO" resultMap="proflVOMap"></collection>
		<collection property="userSeVOList" resultMap="userSeVOMap"></collection>
		<collection property="vCityVOList" resultMap="vCityVOMap"></collection>
		<collection property="spcltyRealmVOList" resultMap="spcltyRealmVOMap"></collection>
	</resultMap>
	
	<resultMap type="proProflVO" id="proflVOMap">
		<result property="proProflOnLiIntrcn" column="PRO_PROFL_ON_LI_INTRCN"/>
		<result property="proProflContactPosblTime" column="PRO_PROFL_CONTACT_POSBL_TIME"/>
		<result property="bcityCode" column="BCITY_CODE"/>
		<result property="brtcCode" column="BRTC_CODE"/>
	</resultMap>
	
	<resultMap type="UsersVO" id="userSeVOMap">
		<result property="userId" column="USER_ID"/>
		<result property="userNcnm" column="USER_NCNM"/>
	</resultMap>
	
	<resultMap type="VCityVO" id="vCityVOMap">
		<result property="bcityNm" column="BCITY_NM"/>
		<result property="brtcNm" column="BRTC_NM"/>
	</resultMap>
	
	<resultMap type="SpcltyRealmVO" id="spcltyRealmVOMap">
		<result property="spcltyRealmNm" column="SPCLTY_REALM_NM"/>
	</resultMap>
	
	
	<select id="proList" parameterType="String" resultMap="proMap">
		 SELECT A.PRO_ID, 
         A.PRO_PROFL_PHOTO, 
         A.SPCLTY_REALM_CODE,
         B.PRO_PROFL_ON_LI_INTRCN, 
         B.PRO_PROFL_CONTACT_POSBL_TIME, 
         B.BCITY_CODE, 
         B.BRTC_CODE,
         C.USER_NCNM,
         D.BCITY_NM,
         D.BRTC_NM,
         E.SPCLTY_REALM_NM
		FROM PRO A
		INNER JOIN PRO_PROFL B ON A.PRO_ID = B.PRO_ID
		INNER JOIN SPCLTY_REALM E ON A.SPCLTY_REALM_CODE = E.SPCLTY_REALM_CODE
		INNER JOIN USERS C ON B.PRO_ID = C.USER_ID
		INNER JOIN V_CITY D ON B.BRTC_CODE = D.BRTC_CODE
	</select>

	<select id="proListPage" parameterType="hashMap" resultMap="proMap">
	    WITH T AS (
	    		SELECT A.PRO_ID, 
                A.PRO_PROFL_PHOTO, 
                A.SPCLTY_REALM_CODE,
                B.PRO_PROFL_ON_LI_INTRCN, 
                B.PRO_PROFL_CONTACT_POSBL_TIME, 
                B.BCITY_CODE, 
                B.BRTC_CODE,
                C.USER_NCNM,
                D.BCITY_NM,
                D.BRTC_NM,
                E.SPCLTY_REALM_NM,
                ROW_NUMBER() OVER(ORDER BY A.PRO_ID ASC) RNUM
		FROM PRO A
		INNER JOIN PRO_PROFL B ON A.PRO_ID = B.PRO_ID
		INNER JOIN SPCLTY_REALM E ON A.SPCLTY_REALM_CODE = E.SPCLTY_REALM_CODE
		INNER JOIN USERS C ON B.PRO_ID = C.USER_ID
		INNER JOIN V_CITY D ON B.BRTC_CODE = D.BRTC_CODE
		WHERE  1 = 1
	            <if test="keyword != null and keyword != ''">
	                AND (
	                    A.PRO_ID LIKE '%' || #{keyword} || '%'
	                    OR B.PRO_PROFL_ON_LI_INTRCN LIKE '%' || #{keyword} || '%'
	                    OR B.PRO_PROFL_CONTACT_POSBL_TIME LIKE '%' || #{keyword} || '%'
	                    OR C.USER_NCNM LIKE '%' || #{keyword} || '%'
	                    OR D.BCITY_NM LIKE '%' || #{keyword} || '%'
		                OR D.BRTC_NM LIKE '%' || #{keyword} || '%'
		                OR D.BCITY_NM || D.BRTC_NM LIKE '%' || #{keyword} || '%'
		                OR E.SPCLTY_REALM_NM  LIKE '%' || #{keyword} || '%'
	                    
	                )
	            </if>
	    )
	    SELECT * FROM T
	    WHERE T.RNUM BETWEEN (#{currentPage} * #{size}) - (#{size} - 1) AND (#{currentPage} * #{size})
	</select>
	
		<select id="getTotal" parameterType="hashMap" resultType="int">
		WITH T AS (
	    SELECT A.PRO_ID, 
                A.PRO_PROFL_PHOTO, 
                A.SPCLTY_REALM_CODE,
                B.PRO_PROFL_ON_LI_INTRCN, 
                B.PRO_PROFL_CONTACT_POSBL_TIME, 
                B.BCITY_CODE, 
                B.BRTC_CODE,
                C.USER_NCNM,
                D.BCITY_NM,
                D.BRTC_NM,
                E.SPCLTY_REALM_NM,
       			ROW_NUMBER() OVER(ORDER BY A.PRO_ID ASC) RNUM
		FROM PRO A
		INNER JOIN PRO_PROFL B ON A.PRO_ID = B.PRO_ID
		INNER JOIN SPCLTY_REALM E ON A.SPCLTY_REALM_CODE = E.SPCLTY_REALM_CODE
		INNER JOIN USERS C ON B.PRO_ID = C.USER_ID
		INNER JOIN V_CITY D ON B.BRTC_CODE = D.BRTC_CODE
        WHERE  1 = 1
		<if test="keyword != null and keyword != ''">
		    AND (
				A.PRO_ID LIKE '%' || #{keyword} || '%'
				OR B.PRO_PROFL_ON_LI_INTRCN LIKE '%' || #{keyword} || '%'
				OR B.PRO_PROFL_CONTACT_POSBL_TIME LIKE '%' || #{keyword} || '%'
				OR C.USER_NCNM LIKE '%' || #{keyword} || '%'
				OR D.BCITY_NM LIKE '%' || #{keyword} || '%'
				OR D.BRTC_NM LIKE '%' || #{keyword} || '%'
				OR D.BCITY_NM || D.BRTC_NM LIKE '%' || #{keyword} || '%'
				OR E.SPCLTY_REALM_NM  LIKE '%' || #{keyword} || '%'
		        
		    )
		</if>
        
		)
		select count(*) from T
		where 1 = 1
		
	</select>
	
	
	<resultMap type="spcltyRealmVO" id="spcltyRealmMap">
		<result property="spcltyRealmCode" column="SPCLTY_REALM_CODE"/>
		<result property="spcltyRealmNm" column="SPCLTY_REALM_NM"/>
		<result property="ptprtSpcltyRealmCode" column="PTPRT_SPCLTY_REALM_CODE"/>
	</resultMap>
	<!-- 서비스 대분류 -->
	<select id="spcltyB" resultMap="spcltyRealmMap">
		SELECT SPCLTY_REALM_NM 
		FROM SPCLTY_REALM
		WHERE SPCLTY_REALM_CODE IN (
		    SELECT SPCLTY_REALM_CODE 
		    FROM SPCLTY_REALM
		    WHERE PTPRT_SPCLTY_REALM_CODE IS NULL
		)
	</select>
	
	<resultMap type="spcltyRealmVO" id="spcltyRealmMap2">
		<result property="spcltyRealmCode" column="SPCLTY_REALM_CODE"/>
		<result property="spcltyRealmNm" column="SPCLTY_REALM_NM"/>
		<result property="ptprtSpcltyRealmCode" column="PTPRT_SPCLTY_REALM_CODE"/>
	</resultMap>
	<!-- 서비스 대분류 -->
	<select id="getSpclty" parameterType="String" resultMap="spcltyRealmMap2">
		SELECT SPCLTY_REALM_NM
		FROM SPCLTY_REALM
		WHERE PTPRT_SPCLTY_REALM_CODE IN
		(SELECT SPCLTY_REALM_CODE
		FROM SPCLTY_REALM
		WHERE SPCLTY_REALM_NM = #{spcltyRealmNm})
	</select>
	
	
	
</mapper>