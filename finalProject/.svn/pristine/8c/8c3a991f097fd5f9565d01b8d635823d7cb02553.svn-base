<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<link rel="stylesheet" href="/resources/skydash/vendors/font-awesome/css/font-awesome.min.css">
<style>
.nav-link.dropdown-toggle::after {
   	display: none;
}
ul.chatMemList {
	list-style-type: none;
}

ul.chatMemList li {
	overflow: hidden;
	margin-bottom: 1.5em;
	display: flex;
   	align-items: center;
   	
}

ul.chatMemList li img {
	width: 30px;
	height: 30px;
	margin-right: 10px;

}
.chatMemDiv {
	margin: 0px;
    width: 100%;
    display: inline-grid;
    align-items: end;
    justify-content: end;
}
	

	
</style>
<script type="text/javascript">

$(function() {
	let userId = `${tdmtngVO.userId}`;
	console.log(userId);
	
	let sessionId = `${sessionId}`;
	console.log(sessionId);
	
	if(userId == sessionId) {
		$("#btnsUpdate").css("display", "inline");	
	}
	let tdmtngMax = `${tdmtngVO.tdmtngMax}`;
	let chatMemCount = `${chatMemCount}`;
	console.log(tdmtngMax);
	console.log(chatMemCount);
	
	if(tdmtngMax == chatMemCount) {
		console.log("꽉 찼다!!");
		$("#btnPrctChat").css("display", "none");
		$("#fullMeeting").css("display", "block");
	}
	
	//모임 참여 여부
	let tdmtngNo = `${tdmtngVO.tdmtngNo}`;
	
	let myChatCk = {
			"userId" : sessionId,
			"tdmtngNo" : tdmtngNo
			}
	
	$.ajax({
        url: "/todayMeeting/selectMyChat",
        contentType: "application/json;charset=utf-8",
        type: "post",
        data: JSON.stringify(myChatCk),
        dataType: "json",
        success: function (tdmtngPrtcpntVO) {
        	console.log(tdmtngPrtcpntVO.tdmtngNo);
        	console.log(tdmtngNo);
        	if(tdmtngPrtcpntVO.tdmtngNo == tdmtngNo) {
        		console.log("참가중");
        		$("#btnPrctChat").css("display", "none");
        		$("#btnPrctedChat").css("display", "block");
        	} 
        	
        }
    });
	
	//모임 멤버 리스트
	$("#iconChatMem").on("click", function() {
		
		$("#chatMemList").html("");
		
		let tdmtngNo = `${tdmtngVO.tdmtngNo}`;

		console.log(tdmtngNo);
		
		$.ajax ({
			url: "/todayMeeting/chatMemList",
			type: "post",
			data: {"tdmtngNo" : tdmtngNo},
			dataType: "json",
			success: function(result) {
				console.log(result);
				
				let str ="";
				
				
				$.each(result, function(idx, tdmtngPrtcpntVO) {
// 					let sexdstnTy = tdmtngPrtcpntVO.mberVOList[0].sexdstnTy;
					let mberPhoto = tdmtngPrtcpntVO.mberProflPhoto;
					let proPhoto = tdmtngPrtcpntVO.proProflPhoto;
					
					console.log("회원 프로필 사진", mberPhoto);
					console.log("프로 프로필 사진", proPhoto);
					
// 					if(sexdstnTy == "SD01") sexdstnTy = "남자";
// 	               	else if(sexdstnTy == "SD02") sexdstnTy = "여자";
// 	               	else sexdstnTy = "기타";
	                 
	               	let emplyrTy = tdmtngPrtcpntVO.usersVOList[0].emplyrTy;
	                 
					if(emplyrTy == "ET01") emplyrTy = "회원";
	               	else if(emplyrTy == "ET02") emplyrTy = "프로";
					
					str += `<div class="card rounded mb-2">`;
					str += `<div class="card-body p-3">`;
					str += `<div class="media">`;
					if(mberPhoto == null && proPhoto != null) {
	        			
	        			console.log("프로 사진?")
	        			str += `<img src='\${proPhoto}' class="img-sm me-3 rounded-circle"></td>`;
	        			
	        		} else if(mberPhoto != null && proPhoto == null){
	        			console.log("멤버 사진?")
	        			str += `<img src='\${mberPhoto}' class="img-sm me-3 rounded-circle"></td>`;
	        		
	        		} else {
	        			console.log("없음 : "+ mberPhoto)
	        			str += `<img src='/images/2024/profile.jpg' class="img-sm me-3 rounded-circle"></td>`;
	        		}
					
					str += `<div class="media-body">`;
					str += `<h6 class="mb-1">\${tdmtngPrtcpntVO.usersVOList[0].userNcnm}(\${tdmtngPrtcpntVO.usersVOList[0].userId})</h6>`;
                    str += `<p class="mb-0 text-muted">\${emplyrTy}</p>`;
                    str += `</div></div></div></div>`;  
				})
				$("#chatMemList").append(str);
			}
			
		})
	})

	//모임 참여 버튼 이벤트 -- 재훈 수정 필요하면  수정 해도 됨
	$("#btnPrctChat").on("click", function() {
		
		let aftusBbscttNo = $("#aftusBbscttNo").val();
		Swal.fire({
			title: '모임에 참여 하시겠습니까?',
			icon: 'warning',
			showCancelButton: true,
			confirmButtonText: '확인',
	        cancelButtonText: '취소',
	        reverseButtons: false,
		}).then((result) => {
			if (result.isConfirmed) {

				let tdmtngMax = `${tdmtngVO.tdmtngMax}`;
				console.log(chatMemCount);
				console.log(tdmtngMax);
				
				$.ajax({
					url: "/todayMeeting/joinChat",
					type: "post",
					data: {"tdmtngNo" : tdmtngNo},
					dataType: "json",
					success: function(result) {
						
						console.log(result);
						
						$("#btnPrctChat").css("display", "none");
		        		$("#btnPrctedChat").css("display", "block");
		        		
	                    chatMemCount++;
	                    
	                    console.log("dd", chatMemCount);
	          
	                    $("#chatMemCount").text(`\${chatMemCount}/\${tdmtngMax}`);
	                    
	                    
	                    if(tdmtngMax == chatMemCount) {
	                		
	                		$("#fullMeeting").css("display", "block");
	                	}
	                    
		        		
					}
				})
			}
		})
		
		
	
	})
	
	//수정하기
	$("#btnTmtEdit").on("click", function() {
		
		let tdmtngDt = $("#tdmtngDt").val();
		console.log(tdmtngDt);
		
		let formattedTdmtngDt = tdmtngDt.replace(/\./g, '-').replace(' ', 'T') + ':00';

		console.log(formattedTdmtngDt);
		$("#tdmtngDt").val(formattedTdmtngDt);
		$("#chatMemDiv").css("display", "none");
		$("#tmtUdtFormDiv").css("display", "block");
		$("#tdmtngCn").css("display", "block");
		$("#btnsUpdate").css("display", "none");
		$("#btnsCkUpdate").css("display", "block");
 		$("#imgUpDiv").css("display", "block");
 		$("#imgPreDiv").css("display", "block");
		$("#tdmtngDt").prop("type", "datetime-local");
		$(".tmtDetail").removeAttr("readonly");
		
		$("#uploadFile").on("change", function() {
			$("#imgDiv").css("display", "none");
		});
		
		$("#uploadFile").on("change",handleImgFileSelect);
		function handleImgFileSelect(e){
		
			let files = e.target.files;
			
			console.log(files);
			let fileArr = Array.prototype.slice.call(files);
		
			fileArr.forEach(function(f){
				//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리(MIME타입)
				console.log(f);
				if(!f.type.match("image.*")){
					alert("이미지 파일만 가능합니다.");
					//함수 종료
					return;
				}
				//이미지 객체를 읽을 자바스크립트의 reader 객체 생성
				let reader = new FileReader();
				
				$(".clsCiImgUrl").html("");
				
				//e : reader가 이미지 객체를 읽는 이벤트
				reader.onload = function(e){
					$(".clsCiImgUrl").css({
				          "background-image": "url(" + e.target.result + ")",
				          "background-position": "center",
				          "background-size": "cover",
				          "width": "500px",
				          "height": "500px"
				    });
//	 				
				}
				//f : 이미지 파일 객체를 읽은 후 다음 이미지 파일(f)을 위해 초기화 함
				reader.readAsDataURL(f);
			});//end forEach
		}
	})
	
	//삭제
	$("#btnTmtDel").on("click", function() {
		location.href = "/todayMeeting/delete?tdmtngNo="+${tdmtngVO.tdmtngNo};
	})
	
	//목록
	$("#btnTmtList").on("click", function() {
		location.href = "/todayMeeting/main";
	})
	
	//수정 화면에서 취소 버튼 클릭시
    $("#btnTmtCancel").on("click", function() {
    	location.href = "/todayMeeting/detail?tdmtngNo="+${tdmtngVO.tdmtngNo};
    })
	

})
</script>

<div class="content-wrapper"
	style="border-top-left-radius: 45px; border-top-right-radius: 45px;">
	<div class="row">
		<div class="col-lg-12">
			<div class="card px-2">
				<div class="card-body">
					<form action="/todayMeeting/update" class="forms-sample" name="tmtUpdate" method="post" enctype="multipart/form-data">
						<div class="container-fluid">
							<input type="hidden" id="tdmtngNo" name="tdmtngNo" value="${tdmtngVO.tdmtngNo}">
							<h2 class="text-center my-5" style="font-family: GMarketSansMedium">${tdmtngVO.tdmtngNm}</h2>
							<div style="margin-left: 76%;">
								<p style="font-family: GMarketSansLight; display: inline; margin-right: 15px;">모임장</p>
								<p style="display: inline;">${tdmtngVO.userNcnm}</p>
								<br />
								<p style="font-family: GMarketSansLight; display: inline;">작성일시</p>
								<p style="display: inline;">${tdmtngVO.tdmtngCreatDt}</p>
								<br />
								<p style="font-family: GMarketSansLight; display: inline;">모임일시</p>
								<p style="display: inline;">${tdmtngVO.tdmtngDt}</p>
							</div>
							<hr>
						</div>
						<div class="container-fluid w-100 row">
							
						
							<div class="form-group chatMemDiv">
				            	<div class="dropdown" id="fileGroup" style="margin-right:0px;">
				            		<img src="/resources/images/모임인원아이콘.png" class="nav-link dropdown-toggle img-unded-circle" 
				            		data-toggle="dropdown" id="iconChatMem" style="height:75px; float:right;">
				            		<div class="dropdown-menu" aria-labelledby="dropdownMenuIconButton6" 
				            			style="min-width: 20rem; background: none; border: none;">	
										<div class="col-md-6 h-100" style="max-width: 100%;">
					                      	<div class="bg-primary p-4 rounded" style="height:100%;">
					                        	<h6 class="card-title text-white">모임 멤버</h6>
					                        	<div class="py-2" id="chatMemList">
					                        	</div>
					                      	</div>
					                    </div>
				                	</div>
				            	</div>
				            	<p id="chatMemCount" style="margin-left: 30px;">(${chatMemCount}/${tdmtngVO.tdmtngMax})</p>
				            </div>
				           
				    		<h5 class="mb-5" style="font-family: GmarketSansLight; padding-left: 20px;">${tdmtngVO.tdmtngCn}</h5>	
				            <div id="imgDiv" class="form-group" style="max-width: 700px">
				                <img src="${tdmtngVO.tdmtngThumbPhoto}" class="img-fluid mb-2" onerror="this.style.display='none'">
				            </div>

						</div>

						<!-- 수정 버튼 클릭시 보이게 하기 -->
						<div id="tmtUdtFormDiv" style="display: none;">
							<label for="tdmtngNm">모임명</label>
               				<input type="text" class="form-control tmtDetail" id="tdmtngNm" name="tdmtngNm" 
               					value="${tdmtngVO.tdmtngNm}">
							 
							<div style="display: flex;">
						        <div class="form-group col-6" style="padding: 0px;">
						            <label for="tdmtngDt">모임일시</label>
									<input type="text" class="form-control tmtDetail" id="tdmtngDt" name="tdmtngDt" 
										value="${tdmtngVO.tdmtngDt}">
						        </div>
						        <div class="form-group col-6" style="padding: 0px;">
						        	<label for="tdmtngMax">정원</label>
						            <input type="text" class="form-control" id="tdmtngMax" name="tdmtngMax" value="${tdmtngVO.tdmtngMax}">
						        </div>
					        </div>
							
							<label for="tdmtngCn">내용</label>
							<textarea class="form-control" rows="10" id="tdmtngCn" name="tdmtngCn"
								style="display: none;">${tdmtngVO.tdmtngCn}</textarea>	
						</div>
						<!-- 수정 버튼 클릭시 보이게 하기 끝 -->

			       	
			       		<div id="imgPreDiv" class="clsCiImgUrl  col-xs-12" style="display: none;">
						</div>		
							       	
			            <div id="imgUpDiv" class="form-group" style="display: none;">
			                <label>이미지 파일</label>
			                <input type="file" id="uploadFile" name="uploadFile" class="file-upload-default" >
			                <div class="input-group col-xs-12">
			                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="파일선택">
			                    <span class="input-group-append">
			                        <button class="file-upload-browse btn btn-primary" type="button">업로드</button>
			                    </span>
			                </div>
			            </div>
						<h6 id="fullMeeting" style="display: none">※ 정원 초과로 마감된 모임 입니다.</h6>
						<div class="container-fluid w-100" style="display: flex; flex-wrap: wrap; float: right;">
							<button type="button" class="btn btn-inverse-primary" id="btnPrctChat" style="margin-right:5px;">모임 참여</button>
            				<button type="button" class="btn btn-primary" id="btnPrctedChat" disabled style="display: none; margin-right:5px;">참여중</button>
							<div id="btnsUpdate" style="display: none; margin-right: 5px;">
								<button type="button" id="btnTmtEdit" class="btn btn-outline-primary">수정</button>
								<button type="button" id="btnTmtDel" class="btn btn-outline-primary">삭제</button>
							</div>
								<button type="button" class="btn btn-outline-secondary" id="btnTmtList" style="margin-right:5px;">목록</button>
							<div id="btnsCkUpdate" style="display: none;">
								<button type="submit" id="btnTmtCkEdit" class="btn btn-primary mr-2">확인</button>
								<button type="button" id="btnTmtCancel" class="btn btn-light">취소</button>
							</div>
							
						</div>

					</form>
				</div>
			</div>
		</div>
	</div>
</div>

