<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<link href="/resources/css/main.css" rel="stylesheet" />
<script type="text/javascript" src="/resources/fullcalendar/main.js"></script>
<script type="text/javascript" src="/resources/fullcalendar/ko.js"></script>


<style>
	.searchForm {
	margin-top: 30px;
	}
	.content-wrapper {
		background: none;
		
		
		
	}
</style>
<script>
  $(function () {
	  
	/* $("#home-tab").on("click", function() {
		$("#home-").
	}) */
	$("#profile-tab").on("click", function() {
		$("#home-tab").attr('class', 'nav-link');
		$("#profile-tab").attr('class', 'nav-link active');
		$("#home-1").attr('class', 'tab-pane fade');
		$("#profile-1").attr('class', 'tab-pane fade active show');
	})
	
	$("#home-tab").on("click", function() {
    	$("#home-tab").attr('class', 'nav-link active');
    	$("#profile-tab").attr('class', 'nav-link');
    	$("#home-1").attr('class', 'tab-pane fade active show');
    	$("#profile-1").attr('class', 'tab-pane fade');
	})
	 
	$("#btnTmtCreate").on("click", function () {
		location.href = "/todayMeeting/create";
	})
	
// 	$("#search_key").on("change", function() {
// 		console.log($("#search_key").val())
// 	})
	

    $("#btnSearch").on("click", function () {
		
   	  
      
      let searchKey = $("#search_key").val();
      let keyword = $("#keyword").val();
      
      
      if (keyword == '') {
        
          Swal.fire({
  			title: '검색어를 입력해주세요',
  			icon: 'warning',
          	confirmButtonText: '확인',
  		}).then((result) => { 
              if (result.isConfirmed) {
            	  $('#keyword').focus();
                  return;
              }
          });
          
          
          
          
          
      }
      
      console.log($("#search_key").val())
      console.log("keyword : " + keyword);

      let data = {
        "keyword": keyword,
        "searchKey": searchKey
      };
      console.log("data : ", data)

      $.ajax({
        url: "/todayMeeting/listAjax",
        contentType: "application/json;charset=utf-8",
        data: JSON.stringify(data),
        type: "post",
        dataType: "json",
        success: function (result) {

          let str = "";

          $("#tmtBody").html("");

          $.each(result, function (idx, tdmtngVO) {
            str += "<tr>";
            str += "<td>" + tdmtngVO.tdmtngNo + "</td>";
            str += "<td><a href='/todayMeeting/detail?tdmtngNo=" + tdmtngVO.tdmtngNo + "'>" + tdmtngVO.tdmtngNm + "</a></td>";
//             str += "<td>" + new Date(tdmtngVO.tdmtngDt).toLocaleString() + "</td>";
			str += "<td>" + tdmtngVO.tdmtngDt + "</td>";
            str += "<td>" + tdmtngVO.userNcnm + "</td>";
            str += "</tr>";
          });

          $("#tmtBody").append(str);
        }
      })
    })

    $.ajax({
      url: "/todayMeeting/listAjax",
      type: "post",
      dataType: "json",
      success: function (result) {
        let str = "";
        $.each(result, function (idx, tdmtngVO) {

          str += "<tr>";
          str += "<td>" + tdmtngVO.tdmtngNo + "</td>";
          str += "<td><a href='/todayMeeting/detail?tdmtngNo=" + tdmtngVO.tdmtngNo + "'>" + tdmtngVO.tdmtngNm + "</a></td>";
          str += "<td>" + tdmtngVO.tdmtngDt + "</td>";
          str += "<td>" + tdmtngVO.userNcnm + "</td>";
          str += "</tr>";
        });
        $("#tmtBody").append(str);
      }
    })

    var request = $.ajax({
      url: "/todayMeeting/calendarList", // 값 불러오기
      method: "GET",
      dataType: "json"
    });
    request.done(function (data) {
      console.log(data); // log로 데이터 찍어주기
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        height: '700px',
        slotMinTime: '08:00', // Day 캘린더에서 시작 시간
        slotMaxTime: '20:00', // Day 캘린더에서 종료 시간
        // 헤더에 표시할 툴바
        headerToolbar: {
          left: 'prev, next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        initialView: 'dayGridMonth', // 초기 로드 될 때 보이는 캘린더 화면 (기본 설정 : 달)
        navLinks: true, // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
        editable: true, // 수정 가능?
        selectable: true, // 달력 일자 드래그 설정 가능
        droppable: true, // 드래그 앤 드롭 
        events: data,
        locale: 'ko', // 한국어 설정

        eventClick: function (info) {

          var tdmtngNo = info.event.id;
          //java.sql.SQLException: 부적합한 열 유형: 1111
          //info.event.todayMeetngCode;  이렇게 썼더니 에러
          //todayMeetngCode는 FullCalendar의 이벤트 객체에 포함되어 있지 않음 따라서 undefined
          //title을 받아보니 잘 받아와짐
          //해결 : info.event.extendedProps를 통해 확장 속성을 가져오거나
          //      info.event.id에 todayMeetngCode를 담아서 가져옴
          location.href = "/todayMeeting/detail?tdmtngNo=" + tdmtngNo;
        }

      });
      calendar.render();
    });

  });
  
  
  
  
  
</script>

<div id="title">
	<h1>오늘 모임</h1>
</div>

<button type="button" class="btn btn-inverse-primary btn-fw" id="btnTmtCreate">모임등록</button>


<div class="card">
	<div class="card-body">
		<ul class="nav nav-tabs" role="tablist">
			<li class="nav-item" role="presentation">
				<a class="nav-link active" id="home-tab" data-bs-toggle="tab" href="#home-1" role="tab" aria-controls="home-1"
					aria-selected="true">내 모임</a>
			</li>
			<li class="nav-item" role="presentation">
				<a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#profile-1" data-bs-target="#profile-1"
					role="tab" aria-controls="profile-1" aria-selected="false" tabindex="-1">모임목록</a>
			</li>

		</ul>
		<div class="tab-content">
			<div class="tab-pane fade active show" id="home-1" role="tabpanel" aria-labelledby="home-tab">
				<div class="media">

					<div class="media-body">
						<div id="calendar" class=cal></div>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="profile-1" role="tabpanel" aria-labelledby="profile-tab">
				<div class="media">

					<div class="media-body">

						<div class="form-group searchForm">
							<div class="input-group">

								<select class="form-control col-sm-2" id="search_key">
									<option value="title">모임명</option>
									<option value="reader">모임장</option>
									<option value="date">모임일자</option>
								</select>
								<input type="text" class="form-control" id="keyword" name="keyword" placeholder="검색어를 입력해주세요">
								<div class="input-group-append">
									<button class="btn btn-sm btn-primary" type="button" id="btnSearch">검색</button>
								</div>
							</div>
						</div>


						<div class="card">
							<div class="card-body">
								<h4 class="card-title">Basic Table</h4>
								<p class="card-description">
									Add class <code>.table</code>
								</p>
								<div class="table-responsive">
									<table class="table">
										<thead>
											<tr>
												<th>번호</th>
												<th>모임명</th>
												<th>모임일시</th>
												<th>모임장</th>
											</tr>
										</thead>
										<tbody id="tmtBody">

										</tbody>
									</table>
								</div>
							</div>
						</div>


					</div>
				</div>
			</div>

		</div>
	</div>
</div>

