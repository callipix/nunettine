<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<script src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/ckeditor.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/translations/ko.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
/*
게시글 번호(자동증가 , sequence)		proStoryBbscttNo	
게시글 제목(직접입력)					proStoryBbscttSj
게시글 내용(직접입력)					proStoryBbscttCn
게시글 작성일자(sysdate)				proStoryBbscttWrDt
게시글 추천수(별도)					proStoryBbscttRecommend
게시글 조회수(별도)					proStoryBbscttRdcnt
프로이야기게시글썸네일사진(직접입력)		proStoryBbscttThumbPhoto
통합첨부파일(사진, 직접입력)			sprviceAtchmnflNo
프로아이디							proId
*/
(function(){
	$(document).ready(function() {
		$("#btnStory").on("click" , function(){
			
			let subject = $("#storySubject").val();
			let content = $("#storyContent").val(window.editor.getData()).val();
			
			console.log("글제목 : " + subject);
			console.log("글내용 : " + content);
			
			let proStoryBbscttVO =
			{
					"proStoryBbscttSj" : subject,
					"proStoryBbscttCn" : content,
					"proStoryBbscttThumbPhoto" : proStoryBbscttThumbPhoto,
					
			}
			
			console.log("xzczxajkhsdhakjs : " + data);
			
			let inputFile = $("#uploadFile");
			
			let files = inputFile[0].files;
			
			let formData = new FormData();
			
			formData.append("subject" , subject);
			formData.append("content" , content);
			
			for(let i = 0 ; i < files.length; i++){
				formData.append("uploadFile" , files[i]);
			}
			
			console.log("data : " + data);
			
			
			if(confirm("글을 작성 하시겠습니까?")){		}
			
			$.ajax({
					url: "proMyStory/insert",
					data : JSON.stringify(data) ,
					dataType: "json",
					contentType : "application/json; charset=utf-8",
					success : function(result){
						console.log("result :" + result);
				}
			})
		})
		
		$("#uploadFile").on("change",handleImgFileSelect);
		//e : onchange 이벤트 객체
		function handleImgFileSelect(e){
			//이벤트가 발생 된 타겟 안에 들어있는 이미지 파일들을 가져와보자
			let files = e.target.files;
			//이미지가 여러개가 있을 수 있으므로 이미지들을 각각 분리해서 배열로 만듦
			let fileArr = Array.prototype.slice.call(files);
			//파일 타입의 배열 반복. f : 배열 안에 들어있는 각각의 이미지 파일 객체
			
			/*
			let arr = ["피자","떡볶이","탕수육"];
			//*******
			arr.forEach(function(str){
				console.log("str : " + str);
			});
			
			$.each(arr,function(idx,str){
				console.log("str[" + idx + "] : " + str);
			});
			*/
			
			fileArr.forEach(function(f){
				//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리(MIME타입)
				if(!f.type.match("image.*")){
					alert("이미지 확장자만 가능합니다.");
					//함수 종료
					return;
				}
				//이미지 객체를 전역 배열타입 변수에 넣자
				sel_file.push(f);
				//이미지 객체를 읽을 자바스크립트의 reader 객체 생성
				let reader = new FileReader();
				
				$(".clsCiImgUrl").html("");
				
				//e : reader가 이미지 객체를 읽는 이벤트
				reader.onload = function(e){
					//e.target : f(이미지 객체)
					//e.target.result : reader가 이미지를 다 읽은 결과
					$(".clsCiImgUrl").css({"background-image":"url("+e.target.result+")","background-position":"center","background-size":"cover"});
//	 				let img_html = "<img src=\"" + e.target.result + "\" style='width:100%;' />";
					//p 사이에 이미지가 렌더링되어 화면에 보임
					//객체.append : 누적, .html : 새로고침, .innerHTML : J/S
//	 				$("#body-content").html(img_html);
				}
				//f : 이미지 파일 객체를 읽은 후 다음 이미지 파일(f)을 위해 초기화 함
				reader.readAsDataURL(f);
			});//end forEach
		}
		
	})
})();
</script>

<!--  -->
<div class="card">
	<div class="card-body">
		<h4 class="card-title"></h4>
		<p class="card-description">
		<p></p>

		<form action="#" name="frm" class="forms-sample" method="post" enctype="multipart/form-data">

			<input type="hidden" class="form-control" id="" name="" value="" required />


			<div class="form-group">
				<label for="storySubject">제목</label>
				<input type="text" class="form-control" id="storySubject" name="storySubject" required>
			</div>

			<div class="form-group">
				<label for="storyContent">내용</label>
				<div id="editor" class="editor"></div>
				<textarea class="form-control" rows="10" id="storyContent" name="storyContent" style="display: none;"></textarea>
			</div>
			
			<div class="form-group">
<!-- 				<div class="list-wrapper pt-1 col-sm-12"> -->
<!-- 					<ul class="d-flex flex-row todo-list todo-list-custom" id="file-list"> -->

<!-- 					</ul> -->
<!-- 				</div> -->
				<div class="input-group col-xs-12">
					<div class="custom-file">
						<input type="file" id="uploadFile" name="uploadFile" class="file-upload-default" multiple="multiple" />

						<span class="input-group-append">
							<button class="file-upload-browse btn btn-primary" type="button">업로드</button>
						</span>
					</div>
				</div>
			</div>

			<button type="button" id="btnStory" class="btn btn-primary mr-2">등록</button>
			<button class="btn btn-light">취소</button>
		</form>
	</div>
</div>

<script type="text/javascript">
ClassicEditor.create(document.querySelector('#editor'),	{ ckfinder : { uploadUrl : '/upload/uploadCk'} , language : "ko" })
.then(editor=>{window.editor=editor;})
.catch(err=>{console.error(err.stack);});
</script>

<!--  -->
<div id="test" style="text-align: center; width: 100%;">
    <div style="width: 600px; margin: 0 auto; text-align: center;">
    </div>
</div>
