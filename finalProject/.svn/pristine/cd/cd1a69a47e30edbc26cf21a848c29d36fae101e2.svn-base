<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/41.2.0/classic/ckeditor.js"></script>
<script type="text/javascript" src="/resources/js/bootstrap.bundle.js"></script>
<link rel="stylesheet"
	href="/resources/skydash/vendors/font-awesome/css/font-awesome.min.css">
<style> 
     .ck-editor__editable_inline{ 
     min-height:500px; 
     }

     .ck-editor__editable_inline{ 
     	min-height:500px; 
    
     }
     ul, li {
     	display: inline;
     }
     .list-wrapper {
     	overflow: hidden;
     }

</style>
<script type="text/javascript">
$(function() {
	
	$("#btnRvEdit").on("click", function() {
		$("#fileUploadDiv").css("display", "block");
		$("#fileGroup").css("display", "none");
		$("#btnRvList").css("display", "none");
	})
	
	
	//드롭다운에 파일 목록 불러오기

// 		let sprviseAtchmnflNo = `${aftusBbscttVO.sprviseAtchmnflNo}`;
		
// 		$("#fileListDiv").html("");
		
// 		$.ajax({
// 			url: "/reviewBoard/fileList",
// 			type: "post",
// 			data: { "sprviseAtchmnflNo" : sprviseAtchmnflNo },
// 			dataType: "json",
// 			success: function(result) {
// 				let str = "";
// 				console.log(result);
// 				$.each(result, function(idx, sprviseAtchmnflVO) {
// 					str += "<a class= 'dropdown-item' href='/resources/upload${sprviseAtchmnflVO.atchmnflCours}' download='${sprviseAtchmnflVO.atchmnflNm}'>" 
// 							+ sprviseAtchmnflVO.atchmnflNm + "</a>";
// 				})
				
// 				$("#fileListDiv").append(str);
// 			}
// 		})


	let userId = `${aftusBbscttVO.userId}`;
	console.log(userId);
	
	let sessionId = `${sessionId}`;
	console.log(sessionId);
	
	if(userId == sessionId) {
		$("#btnsUpdate").css("display", "inline");	
	}
	
	//ckEditor 내용 입력
	$(".ck-blurred").keydown(function(){
		console.log("str : " + window.editor.getData());
		$("#aftusBbscttCn").val(window.editor.getData());
	});
	
	$(".ck-blurred").on("focusout", function(){
		console.log("str : " + window.editor.getData());
		$("#aftusBbscttCn").val(window.editor.getData());
		
	});
	
	//수정 화면에서 취소 버튼 클릭시
    $("#btnRvCancel").on("click", function() {
    	location.href = "/reviewBoard/detail?aftusBbscttNo="+${aftusBbscttVO.aftusBbscttNo};
    })
	
	//후기 수정
	$("#btnRvEdit").on("click", function() {
		$(".rvDetail").removeAttr("readonly");
		
		$("#btnsUpdate").css("display", "none");
		$("#btnsCkUpdate").css("display", "block");
		
		$("#rvCon").css("display", "none");
		$("#ckEditorDiv").css("display", "block");
		
		$("#imgUpDiv").css("display", "block");
	
		
		
// 		$("#uploadFile").on("change",handleImgFileSelect);
// 		function handleImgFileSelect(e){
// 			//이벤트가 발생 된 타겟 안에 들어있는 이미지 파일들을 가져와보자
// 			let files = e.target.files;
			

// 			console.log(files);
// 			let fileArr = Array.prototype.slice.call(files);
		
// 			fileArr.forEach(function(f){
// 				//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리(MIME타입)
				
// 				console.log(f);
// 				if(!f.type.match("image.*")){
// 					alert("이미지 파일만 가능합니다.");
// 					//함수 종료
// 					return;
// 				}
// 				//이미지 객체를 전역 배열타입 변수에 넣자
// 				//이미지 객체를 읽을 자바스크립트의 reader 객체 생성
// 				let reader = new FileReader();
				
// 				$(".clsCiImgUrl").html("");
				
// 				//e : reader가 이미지 객체를 읽는 이벤트
// 				reader.onload = function(e){
// 					$(".clsCiImgUrl").css({
// 				          "background-image": "url(" + e.target.result + ")",
// 				          "background-position": "center",
// 				          "background-size": "cover",
// 				          "width": "300px", 
// 				          "height": "200px",
// 				          "border": "1px solid #ccc"
// 				    });
// //	 				
// 				}
// 				//f : 이미지 파일 객체를 읽은 후 다음 이미지 파일(f)을 위해 초기화 함
// 				reader.readAsDataURL(f);
// 			});//end forEach
// 		}
		
	})
	
	
	
	$("#btnRvList").on("click", function() {
		location.href = "/reviewBoard/main";
	})
	$("#btnRvDel").on("click", function() {
		let aftusBbscttNo = $("#aftusBbscttNo").val();
		Swal.fire({
			title: '정말 삭제 하시겠습니까?',
			icon: 'warning',
			showCancelButton: true,
			confirmButtonText: '확인',
	        cancelButtonText: '취소',
	        reverseButtons: false,
		}).then((result) => {
			if (result.isConfirmed) {
				$.ajax({
					url: "/reviewBoard/delete",
					type: "post",
					data: {"aftusBbscttNo" : aftusBbscttNo},
					success: function(result) {
						Swal.fire({
							title: '삭제가 완료 됐습니다.',
							icon: 'confirm',
			            	confirmButtonText: '확인',
						}).then((result) => {
							location.href = "/reviewBoard/main";
						})
						
					}
				
				})
			}
		})

		/* location.href = "/reviewBoard/delete?aftusBbscttNo=" + ${aftusBbscttVO.aftusBbscttNo} */
	})

	

	
// 	$(".ti-close").on("click", function() {
		
// 		$('#file-list li').remove();
// 		console.log($('#file-list li'));
		
// 	    selectedFiles.splice(0, 1);
// 	    console.log($(selectedFiles));
// 	})

	$(".ti-close").on("click", function() {
		let liElement = $(this).closest('li');
		
		let fileName = liElement.text().trim();
	    let sprviseAtchmnflNo = liElement.find('input[name="sprviseAtchmnflNo"]').val();
	    let atchmnflNo = liElement.find('input[name="atchmnflNo"]').val();
		
	    console.log(sprviseAtchmnflNo);
	    console.log(atchmnflNo);
	    console.log($('#file-list li'));
	    console.log(fileName);
	    
		liElement.remove();
	    
	    let index = selectedFiles.indexOf(fileName);
	    selectedFiles.splice(index, 1);
	    
	    let delFileInfo = {
	            "sprviseAtchmnflNo" : sprviseAtchmnflNo,
	            "atchmnflNo" : atchmnflNo
	    };
	    
	    console.log(delFileInfo);
	    
	    $.ajax({
			url:"/reviewBoard/fileDel",
			type:"post",		
			data:JSON.stringify(delFileInfo),
			contentType:"application/json;chatset=utf-8",
			dataType:"text",
			success:function(res){
				console.log("fileDel->res : " + res);
			}
			
		});
	    
	});
	
})


let selectedFiles = [];


function test(uploadFile) {
    console.log(uploadFile);
    const fileList = $('#file-list');
    
    
    for (let i = 0; i < uploadFile.length; i++) {
		
        selectedFiles.push(uploadFile[i]);
        console.log(selectedFiles);
        const item = $('<li></li>');
        const fileName = $(document.createTextNode(uploadFile[i].name));
        console.log(fileName);
        const deleteButton = $('<i class="remove ti-close"></i>');
        
        
        deleteButton.on('click', (event) => {
            item.remove();
            event.preventDefault();
            deleteFile(uploadFile[i]);
        });
        
        item.append(fileName);
        item.append(deleteButton);
        fileList.append(item);
    }
    
    
}

function deleteFile(deleteFile) {
    var inputFile = $("#uploadFile");
    var dataTransfer = new DataTransfer();
    selectedFiles = selectedFiles.filter(function(uploadFile) {
        return uploadFile !== deleteFile;
    });
    selectedFiles.forEach(function(uploadFile) {
        dataTransfer.items.add(uploadFile);
    });
    inputFile.files = dataTransfer.files;
}

// //첨부파일 삭제 버튼 이벤드
// function fileDel(sprviseAtchmnflNo,atchmnflNo,statCount){
// 	console.log("sprviseAtchmnflNo : " + sprviseAtchmnflNo);
// 	console.log("atchmnflNo : " + atchmnflNo);
// 	console.log("statCount : " + statCount)
	
// 	let data = {
// 		"sprviseAtchmnflNo":sprviseAtchmnflNo,
// 		"atchmnflNo":atchmnflNo
// 	}
// 	console.log("data : ",data)
	
// 	$.ajax({
// 		url:"/lbrtybbsctt/fileDel",
// 		type:"post",		
// 		data:JSON.stringify(data),
// 		contentType:"application/json;chatset=utf-8",
// 		dataType:"text",
// 		success:function(res){
// 			console.log("fileDel->res : " + res);
// 			$("#fileDel").hide();
// 		}
		
// 	});
// }




</script>

<div class="card">
    <div class="card-body">
        <p></p>
        <form action="/reviewBoard/update" class="forms-sample" name="rvUpdate" method="post" enctype="multipart/form-data">
<!--         	파일번호가 0으로 넘어가면 update가 아닌 insert를 해주기 위한 처리 -->
        	<input type="hidden" name="sprviseAtchmnflNo" value="${aftusBbscttVO.sprviseAtchmnflNo}">
            <div class="form-group">
                <label for="aftusBbscttNo">번호</label>
				<input type="text" class="form-control" id="aftusBbscttNo" name="aftusBbscttNo" value="${aftusBbscttVO.aftusBbscttNo}" readonly>
			</div>
            <div class="form-group">
                <label for="aftusBbscttSj">제목</label>
                <input type="text" class="form-control rvDetail" id="aftusBbscttSj" name="aftusBbscttSj" value="${aftusBbscttVO.aftusBbscttSj}" readonly>
            </div>
            <div class="form-group">
            	<label for="userNcnm">작성자</label>
				<input type="text" class="form-control" id="userNcnm" name="userNcnm" value="${aftusBbscttVO.userNcnm}" readonly>
            </div>
            <div class="form-group">
                <label for="aftusBbscttWrDt">작성일자</label>
				<input type="text" class="form-control" id="aftusBbscttWrDt" name="aftusBbscttWrDt" value="${aftusBbscttVO.aftusBbscttWrDt}" readonly>
            </div>
            <div class="form-group">
            	<label for="aftusBbscttRdcnt">조회수</label>
				<input type="text" class="form-control" id="aftusBbscttRdcnt" name="aftusBbscttRdcnt" value="${aftusBbscttVO.aftusBbscttRdcnt}" readonly>
            </div>
            
            <div class="form-group">
            	<label for="srvcRequstNo">서비스 요청 번호</label>
				<input type="text" class="form-control" id="srvcRequstNo" name="srvcRequstNo" value="${aftusBbscttVO.srvcRequstNo}" readonly>
            </div>
            
            
        
            <div id="rvCon">${aftusBbscttVO.aftusBbscttCn}</div>
            
            
            <div class="form-group" id="ckEditorDiv" style="display: none;">
       			<label for="aftusBbscttCn">내용</label>
        		<div id="ckEditor">${aftusBbscttVO.aftusBbscttCn}</div>
       			<textarea class="form-control" rows="10" id="aftusBbscttCn" name="aftusBbscttCn" style="display: none;"></textarea>
      		</div>
      		
      		
			
      		<div class="dropdown" id="fileGroup">
            	<button class="btn btn-inverse-primary dropdown-toggle" type="button" id="btnFileView" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                	<i class="fa fa-download"></i>
                </button>
					<div class="dropdown-menu" id="fileListDiv" aria-labelledby="dropdownMenuIconButton6" style="">	
                    	<c:forEach var="fileList" items="${fileList}" varStatus="stat">
							<a class= "dropdown-item" href="/resources/upload${fileList.atchmnflCours}" download="${fileList.atchmnflNm}">
 							${fileList.atchmnflNm}</a>
						</c:forEach>
                	</div>		
               
			</div>
      		
      		
      		
      		<div class="form-group" id="fileUploadDiv" style="display: none;">
				<div class="list-wrapper pt-1 col-sm-12">
					<ul class="d-flex flex-row todo-list todo-list-custom" id="file-list">
					<!-- 수정시 기존 파일리스트가 들어가는 곳 -->
						<c:forEach var="fileList" items="${fileList}" varStatus="stat">
							<li>${fileList.atchmnflNm}<i class="remove ti-close"></i>
								<input type="hidden" name="sprviseAtchmnflNo" value="${fileList.sprviseAtchmnflNo}"></input>
								<input type="hidden" name="atchmnflNo" value="${fileList.atchmnflNo}"></input>
							</li>
						</c:forEach>
					
					</ul>
				</div>
				<div class="input-group col-xs-12">
					<div class="custom-file">
						<input type="file" id="uploadFile" name="uploadFile" class="file-upload-default" multiple="multiple" onchange="test(this.files)">

						<span class="input-group-append">
							<button class="file-upload-browse btn btn-primary" type="button">업로드</button>
						</span>
					</div>
				</div>
			</div>
            

<!--             <div class="form-group"> -->
<!--                 <label for="aftusBbscttCn">후기내용</label> -->
<%--                 <textarea class="form-control rvDetail" rows="10" id="aftusBbscttCn" name="aftusBbscttCn" readonly>${aftusBbscttVO.aftusBbscttCn} --%>
<!--                 </textarea> -->
<!--             </div> -->
         

<!--        		<div id="imgPreDiv" class="clsCiImgUrl  col-xs-12" style="display: none;"> -->
<!-- 			</div> -->
             
       	
<!--             <div id="imgUpDiv" class="form-group" style="display: none;"> -->
<!--                 <label>이미지 파일</label> -->
<!--                 <input type="file" id="uploadFile" name="uploadFile" class="file-upload-default" > -->
<!--                 <div class="input-group col-xs-12"> -->
<!--                     <input type="text" class="form-control file-upload-info" disabled="" placeholder="파일선택"> -->
<!--                     <span class="input-group-append"> -->
<!--                         <button class="file-upload-browse btn btn-primary" type="button">업로드</button> -->
<!--                     </span> -->
<!--                 </div> -->
<!--             </div> -->



            <div id="btnsUpdate"  style="display: none;">
            	<button type="button" id="btnRvEdit" class="btn btn-primary mr-2">수정</button>
            	<button type="button" id="btnRvDel" class="btn btn-primary mr-2">삭제</button>
            </div>
            <button type="button" class="btn btn-light" id="btnRvList">목록</button>
            <div id="btnsCkUpdate" style="display: none;">
				<button type="submit" id="btnRvCkEdit" class="btn btn-primary mr-2">확인</button>
				<button type="button" id="btnRvCancel" class="btn btn-light">취소</button>
			</div>
            
        </form>
    </div>
</div>

<script type="text/javascript">
ClassicEditor
 .create(document.querySelector('#ckEditor'),
		{ckfinder:{uploadUrl:'/upload/uploads'}})
 .then(editor=>{window.editor=editor;})
 .catch(err=>{console.error(err.stack);});
</script>