<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.chatting.mapper.ChatMapper">
		<!-- 1. 방생성 -->
		<insert id="insertRoom" parameterType="kr.or.ddit.chatting.vo.ChatRoomVO">
			<selectKey resultType="int" order="BEFORE" keyProperty="roomNo">
				SELECT CHAT_ROOM_SEQ.NEXTVAL FROM DUAL
			</selectKey>
					INSERT ALL
					    
					    INTO CHAT_ROOM(ROOM_NO  ,   ROOM_NAME  , CREATE_DATE , USER_ID)
					            VALUES(#{roomNo},  #{roomName} , SYSDATE     , #{userId})
					    
					    INTO CHAT_RELAY(USER_ID, ROOM_NO)
					    VALUES(#{userId} , #{roomNo})
					    
					SELECT * FROM DUAL
		</insert>
		
		<!-- 2.채팅방 목록 불러오기 -->
		<select id="chatRoomList" resultType="kr.or.ddit.chatting.vo.ChatRoomVO">
			SELECT ROOM_NO, ROOM_NAME, CREATE_DATE, USER_ID
			 FROM CHAT_ROOM
			ORDER BY ROOM_NO DESC
		</select>
		
		<!--  -->
		<resultMap type ="kr.or.ddit.chatting.vo.ChatRoomVO" id="chatRoomMap">
			<result property="roomNo" column="roomNo" />
			<result property="roomName" column="roomName" />
			<result property="createDate" column="createDate" />
			<result property="userId" column="userId" />
		</resultMap>
		
		<resultMap type ="kr.or.ddit.chatting.vo.ChatRelayVO" id="chatRelayMap">
			<result property="roomNo" column="roomNo" />
			<result property="userId" column="userId" />
		</resultMap>
		
		<select id="getRelay" parameterType="int" resultType="kr.or.ddit.chatting.vo.ChatRelayVO">
			SELECT ROOM_NO , USER_ID
			FROM CHAT_RELAY
			WHERE ROOM_NO = #{roomNo}
		</select>

		<!--  -->
<!-- 		<select id="getRoom" parameterType="int" resultType="kr.or.ddit.chatting.vo.ChatRoomVO"> -->
<!-- 			SELECT ROOM_NO , ROOM_NAME , CREATE_DATE . USER_ID -->
<!-- 			FROM CHAT_ROOM -->
<!-- 			WHERE ROOM_NO = #{roomNo} -->
<!-- 		</select> -->
		
		<!-- 3.채팅방 참가 -->
		<insert id="joinChat" parameterType="String">
			INSERT INTO CHAT_RELAY(ROOM_NO , USER_ID)
			VALUES (#{roomNo} , #{userId})
		</insert>
		
		<!-- 4.해당 채팅방 정보 -->
		<select id="getRoomInfo" parameterType="hashMap" resultMap="chatRoomMap">
				SELECT  A.ROOM_NO, A.ROOM_NAME, A.CREATE_DATE
					  , B.USER_ID
				  FROM  CHAT_ROOM  A LEFT JOIN  CHAT_RELAY B ON 
						A.ROOM_NO = B.ROOM_NO
				 WHERE  A.ROOM_NO = #{roomNo}
		</select>
		
		<!-- 5.해당 채팅방에 존재하는 유저 -->
		<select id="getRoomUsers" parameterType="int" resultType="java.util.List">
				SELECT   A.ROOM_NO
					   , B.USER_ID
				  FROM  CHAT_ROOM  A LEFT JOIN  CHAT_RELAY B ON 
						A.ROOM_NO = B.ROOM_NO
				 WHERE  A.ROOM_NO = #{roomNo}
		</select>
		
		<!-- 6.해당 채팅방에 존재하는 인원수 -->
		<select id="roomMemberCount">
		SELECT COUNT(G.ROOM_NO)
		  FROM
		  		(
					SELECT  A.ROOM_NO
						   ,B.USER_ID
					  FROM CHAT_ROOM A LEFT JOIN CHAT_RELAY B
					    ON A.ROOM_NO = B.ROOM_NO
					 WHERE A.ROOM_NO = #{roomNo} ) G
		</select>
		
		<!-- 7.채팅방 검색 -->
		
</mapper>