<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<link rel="stylesheet"
	href="/resources/skydash/vendors/font-awesome/css/font-awesome.min.css">
<style>
	.nav-link.dropdown-toggle::after {
    	display: none;
	}
	ul.chatMemList {
		list-style-type: none;
	}
	
	ul.chatMemList li {
		overflow: hidden;
		margin-bottom: 1.5em;
		display: flex;
    	align-items: center;
    	
	}

	ul.chatMemList li img {
		width: 30px;
		height: 30px;
		margin-right: 10px;

	}
	

	
</style>
<script type="text/javascript">

$(function() {
	let userId = `${tdmtngVO.userId}`;
	console.log(userId);
	
	let sessionId = `${sessionId}`;
	console.log(sessionId);
	
	if(userId == sessionId) {
		$("#btnsUpdate").css("display", "inline");	
	}
	
	

	
	//모임 참여 여부
	let tdmtngNo = `${tdmtngVO.tdmtngNo}`;
	
	let myChatCk = {
			"userId" : sessionId,
			"tdmtngNo" : tdmtngNo
			}
	
	$.ajax({
        url: "/todayMeeting/selectMyChat",
        contentType: "application/json;charset=utf-8",
        type: "post",
        data: JSON.stringify(myChatCk),
        dataType: "json",
        success: function (tdmtngPrtcpntVO) {
        	console.log(tdmtngPrtcpntVO.tdmtngNo);
        	console.log(tdmtngNo);
        	if(tdmtngPrtcpntVO.tdmtngNo == tdmtngNo) {
        		console.log("참가중");
        		$("#btnPrctChat").css("display", "none");
        		$("#btnPrctedChat").css("display", "block");
        	} 
        	
        }
    });
	
	//모임 멤버 리스트
	$("#iconChatMem").on("click", function() {
		
		$("#chatMemList").html("");
		
		let tdmtngNo = `${tdmtngVO.tdmtngNo}`;

		console.log(tdmtngNo);
		
		$.ajax ({
			url: "/todayMeeting/chatMemList",
			type: "post",
			data: {"tdmtngNo" : tdmtngNo},
			dataType: "json",
			success: function(result) {
				console.log(result);
				
				let str ="";
				
				
				$.each(result, function(idx, tdmtngPrtcpntVO) {
					let sexdstnTy = tdmtngPrtcpntVO.mberVOList[0].sexdstnTy;
	                 
					if(sexdstnTy == "SD01") sexdstnTy = "남자";
	               	else if(sexdstnTy == "SD02") sexdstnTy = "여자";
	               	else sexdstnTy = "기타";
	                 
	               	let emplyrTy = tdmtngPrtcpntVO.usersVOList[0].emplyrTy;
	                 
					if(emplyrTy == "ET01") emplyrTy = "회원";
	               	else if(emplyrTy == "ET02") emplyrTy = "프로";
					str += "<li>";	
					str += "<img src='" + tdmtngPrtcpntVO.mberVOList[0].mberProflPhoto + "' alt='' class='left' />";
					str += "<h6>" + tdmtngPrtcpntVO.usersVOList[0].userNcnm + tdmtngPrtcpntVO.usersVOList[0].userId + "</h6>";
					str += "<p>" + sexdstnTy + emplyrTy + "</p>";
					str += "</li>";
				})
				$("#chatMemList").append(str);
			}
			
		})
	})
	
	
	//채팅 참여 버튼 이벤트
	$("#btnPrctChat").on("click", function() {
		
		let aftusBbscttNo = $("#aftusBbscttNo").val();
		Swal.fire({
			title: '모임에 참여 하시겠습니까?',
			icon: 'warning',
			showCancelButton: true,
			confirmButtonText: '확인',
	        cancelButtonText: '취소',
	        reverseButtons: false,
		}).then((result) => {
			if (result.isConfirmed) {
				let tdmtngNo = `${tdmtngVO.tdmtngNo}`;
				
				console.log(tdmtngNo);
//		 		location.href = "/todayMeeting/joinChat?tdmtngNo=" + `${tdmtngVO.tdmtngNo}`;
				$.ajax({
					url: "/todayMeeting/joinChat",
					type: "post",
					data: {"tdmtngNo" : tdmtngNo},
					dataType: "json",
					success: function(result) {
						
						console.log(result);
						
						$("#btnPrctChat").css("display", "none");
		        		$("#btnPrctedChat").css("display", "block");
						
					}
				})
			}
		})
		
		
	
	})
	
	//수정하기
	$("#btnTmtEdit").on("click", function() {
		
		let tdmtngDt = $("#tdmtngDt").val();
		console.log(tdmtngDt);

// 		let date = new Date(tdmtngDt);
		
		let formattedTdmtngDt = tdmtngDt.replace(/\./g, '-').replace(' ', 'T') + ':00';
//		이 방법도 있음!
// 		let splitDate = tdmtngDtx.split('.'); // '.'을 기준으로 배열로 자름
// 		let formattedDate = splitDate.join('-'); // 배열을 '-'로 연결
		
		/* formattedTdmtngDt += ':00' */	
		console.log(formattedTdmtngDt);
		$("#tdmtngDt").val(formattedTdmtngDt);

		
		$("#btnsUpdate").css("display", "none");
		$("#btnsCkUpdate").css("display", "block");
 		$("#imgUpDiv").css("display", "block");
 		$("#imgPreDiv").css("display", "block");
		$("#tdmtngDt").prop("type", "datetime-local");
		$(".tmtDetail").removeAttr("readonly");
		
		
		//$("#tmtUpdate").attr("action", "/todayMeeting/update");
		
		$("#uploadFile").on("change", function() {
			$("#imgDiv").css("display", "none");
		});
		
		$("#uploadFile").on("change",handleImgFileSelect);
		function handleImgFileSelect(e){
			//이벤트가 발생 된 타겟 안에 들어있는 이미지 파일들을 가져옴
			let files = e.target.files;
			
			console.log(files);
			let fileArr = Array.prototype.slice.call(files);
		
			fileArr.forEach(function(f){
				//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리(MIME타입)
				console.log(f);
				if(!f.type.match("image.*")){
					alert("이미지 파일만 가능합니다.");
					//함수 종료
					return;
				}
				//이미지 객체를 읽을 자바스크립트의 reader 객체 생성
				let reader = new FileReader();
				
				$(".clsCiImgUrl").html("");
				
				//e : reader가 이미지 객체를 읽는 이벤트
				reader.onload = function(e){
					$(".clsCiImgUrl").css({
				          "background-image": "url(" + e.target.result + ")",
				          "background-position": "center",
				          "background-size": "cover",
				          "width": "500px", 
				          "height": "500px",
			
				    });
//	 				
				}
				//f : 이미지 파일 객체를 읽은 후 다음 이미지 파일(f)을 위해 초기화 함
				reader.readAsDataURL(f);
			});//end forEach
		}
	})
	
	//삭제
	$("#btnTmtDel").on("click", function() {
		location.href = "/todayMeeting/delete?tdmtngNo="+${tdmtngVO.tdmtngNo};
	})
	
	//목록
	$("#btnTmtList").on("click", function() {
		location.href = "/todayMeeting/main";
	})
	
	//수정 화면에서 취소 버튼 클릭시
    $("#btnTmtCancel").on("click", function() {
    	location.href = "/todayMeeting/detail?tdmtngNo="+${tdmtngVO.tdmtngNo};
    })
	
// 	//수정 화면에서 취소 버튼 클릭시
// 	$("#btnTmtCancel").on("click", function() {
//     $("#btnsUpdate").css("display", "block");
//     $("#btnsCkUpdate").css("display", "none");
//     $("#tdmtngDt").prop("type", "text");
//     $(".tmtDetail").attr("readonly", "readonly");
//     });
})
</script>

<div class="card">
    <div class="card-body">
        <form action="/todayMeeting/update" class="forms-sample" name="tmtUpdate" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="tdmtngNo">번호</label>
				<input type="text" class="form-control" id="tdmtngNo" name="tdmtngNo" value="${tdmtngVO.tdmtngNo}" readonly>
			</div>
            <div class="form-group">
                <label for="tdmtngNm">모임명</label>
                <input type="text" class="form-control tmtDetail" id="tdmtngNm" name="tdmtngNm" value="${tdmtngVO.tdmtngNm}" readonly>
            </div>
<!--              <div class="form-group"> -->
<!--                 <label for="tdmtngCreatDt">모임생성일</label> -->
<%--               	<fmt:formatDate value="${tdmtngVO.tdmtngCreatDt}" pattern="yyyy-MM-dd'T'HH:mm" var="formattedDate1"/> --%>
<%-- 				<input type="text" class="form-control" id="tdmtngCreatDt" name="tdmtngCreatDt" value="${formattedDate1}" readonly> --%>
<!--             </div> -->

			<div class="form-group">
                <label for="tdmtngCreatDt">모임생성일</label>
				<input type="text" class="form-control" id="tdmtngCreatDt" name="tdmtngCreatDt" value="${tdmtngVO.tdmtngCreatDt}" readonly>
            </div>
            
            <div class="form-group">
                <label for="tdmtngDt">모임일자</label>
				<input type="text" class="form-control tmtDetail" id="tdmtngDt" name="tdmtngDt" value="${tdmtngVO.tdmtngDt}" readonly>
            </div>
            
            <div class="form-group">
                <label for="userNcnm">모임장</label>
                    <input type="text" class="form-control" id="userNcnm" name="userNcnm" value="${tdmtngVO.userNcnm}" readonly>
            </div>
            <div class="form-group">
                <label for="tdmtngCn">모임내용</label>
                <textarea class="form-control tmtDetail" rows="10" id="tdmtngCn" name="tdmtngCn" readonly>${tdmtngVO.tdmtngCn}
          
                </textarea>
            </div>
        
            <div class="form-group">           
            	<div class="dropdown" id="fileGroup">
            		<a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="dropdownChatMem">
            		<i class="fa fa-group" id="iconChatMem"></i>
            		</a>
            	<div class="dropdown-menu" aria-labelledby="dropdownMenuIconButton6" style="">	
                    <ul id="chatMemList" class="chatMemList">			
					</ul>  
                </div>		
            </div>
     
            <label for="chatMemCount">참여 인원 </label>
                <input type="text" class="form-control" id="chatMemCount" name="chatMemCount" value="${chatMemCount}" readonly>
            </div>
         	
<!--          	<a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" id="profileDropdown"> -->
<!--           		<img src="C:\\eGovFrameDev-3.10.0-64bit\\workspace\\myFinalProject\\src\\main\\webapp\\resources\\upload\\2024\\03\\09\\c31ea809-ce22-4937-9138-376a621d17e0_ccc.jpg" alt="profile"> -->
<!--         	</a> -->
<!-- 			<div> -->
<!--         	<a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown"> -->
<%-- 	            <c:if test="${empty memSession.profile}"> --%>
<!-- 					<img src="/images/2024/jun.jpg" style="float:left; height:30px; width:30px;" class="img-lg rounded-circle mb-1"/> -->
					
<%-- 				</c:if> --%>
<%-- 				<c:if test="${not empty memSession.profile}"> --%>
<%-- 					<img src="${memSession.profile}" style="float:left; height:30px; width:30px;" /> --%>
<%-- 				</c:if> --%>
<!--             </a> -->
<!--          	</div> -->
         	
         	
         	
            <div id="imgDiv" class="form-group">
                <img src="/resources/upload${tdmtngVO.tdmtngThumbPhoto}" class="img-fluid mb-2" onerror="this.style.display='none'">
            </div>
       	
       		<div id="imgPreDiv" class="clsCiImgUrl  col-xs-12" style="display: none;">
			</div>
             
       	
            <div id="imgUpDiv" class="form-group" style="display: none;">
                <label>이미지 파일</label>
                <input type="file" id="uploadFile" name="uploadFile" class="file-upload-default" >
                <div class="input-group col-xs-12">
                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="파일선택">
                    <span class="input-group-append">
                        <button class="file-upload-browse btn btn-primary" type="button">업로드</button>
                    </span>
                </div>
            </div>
            <div id="btnsUpdate" style="display: none;">
            	<button type="button" id="btnTmtEdit" class="btn btn-primary mr-2">수정</button>
            	<button type="button" id="btnTmtDel" class="btn btn-primary mr-2">삭제</button>
            </div>
            <button type="button" class="btn btn-light" id="btnTmtList">목록</button>
            <button type="button" class="btn btn-inverse-primary" id="btnPrctChat">모임 참여</button>
            <button type="button" class="btn btn-primary" id="btnPrctedChat" disabled style="display: none;">참여중</button>
            
            <div id="btnsCkUpdate" style="display: none;">
				<button type="submit" id="btnTmtCkEdit" class="btn btn-primary mr-2">확인</button>
				<button type="button" id="btnTmtCancel" class="btn btn-light">취소</button>
			</div>
            
        </form>
        
    </div>
</div>