<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<script src="/resources/js/jquery.min.js"></script>
<style>
.star_rating {
  width: 100%; 
  box-sizing: border-box; 
  display: inline-flex; 
  float: left;
  flex-direction: row; 
  justify-content: flex-start;
}
.star_rating .star {
  width: 25px; 
  height: 25px; 
  margin-right: 10px;
  display: inline-block; 
  background: url('https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FE2bww%2FbtsviSSBz4Q%2F5UYnwSWgTlFt6CEFZ1L3Q0%2Fimg.png') no-repeat; 
  background-size: 100%; 
  box-sizing: border-box; 
}
.star_rating .star.on {
  width: 25px; 
  height: 25px;
  margin-right: 10px;
  display: inline-block; 
  background: url('https://blog.kakaocdn.net/dn/b2d6gV/btsvbDoal87/XH5b17uLeEJcBP3RV3FyDk/img.png') no-repeat;
  background-size: 100%; 
  box-sizing: border-box; 
}

.star_box {
  width: 400px;
  box-sizing: border-box;
  display: inline-block;
  margin: 15px 0;
  background: #F3F4F8;
  border: 0;
  border-radius: 10px;
  height: 100px;
  resize: none;
  padding: 15px;
  font-size: 13px;
  font-family: sans-serif;
}

#showReviewModal{
    width: 430px;
    background-color: white;
    padding-right: 17px;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    height: 35%;
    padding: 15px;
    border-radius: 10px;
}

#modalBackdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* 검은색 배경에 투명도 추가 */
    z-index: 999; /* 다른 요소 위에 배치 */
    display: none; 
}
</style>
<div class="col-md-12 grid-margin grid-margin-md-0">
    <div class="card">
        <div class="card-body text-center">
            <div>
                <img src="../../../assets/images/faces/face5.jpg" class="img-lg rounded-circle mb-2" alt="profile image">
                <h4>Maria Johnson</h4>
                <p class="text-muted mb-0">Developer</p>
            </div>
            <p class="mt-2 card-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean commodo ligula eget dolor. Lorem</p>
            <button class="btn btn-info btn-sm mt-3 mb-4">Follow</button>
            <div class="border-top pt-3">
                <div class="row">
                    <div class="col-4">
                        <h6 id="srvcRqCnt">5896</h6>
                        <button type="button" id="srvcRqBtn" class="btn btn-outline-primary btn-sm">이용 완료 서비스</button>
                    </div>
                    <div class="col-4">
                        <h6 id="reviewWrCnt">1596</h6>
                        <button type="button" id="reviewWrBtn" class="btn btn-outline-primary btn-sm">나의 리뷰</button>
                    </div>
                    <div class="col-4">
                        <h6 id="reScoreAvg">7896</h6>
                        <button type="button" id="reScoreAvgBtn"class="btn btn-outline-primary btn-sm">나의 평균 별점</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 리스트섹션 -->
<div class="listGrid" >
</div>
<div id="divPaging"></div>
<script>
//이용 완료 서비스 확인
$("#srvcRqBtn").on("click",function(){
	// 전체 목록
	let currentPage = "${param.currentPage}";
	if(currentPage == ""){
		currentPage = "1";
	}
	
	let size = "5";
	
	let data = {
			"keyword" : "${param.keyword}",
			"currentPage" : currentPage,
			"size" : size
	}
	console.log("기본 리스트 data : ", data);
	
	$.ajax({
		url : "/srvcRequst/srvcRqSuccessList",
	    contentType : "application/json; charset=utf-8",
	    data : JSON.stringify(data),
	    type : "post",
	    dataType : "json",
	    success : function(res){
	    	console.log("이용완료 res :" , res);
	    	$("#srvcRqCnt").text(res.total);
	    	$(".listGrid").html("");
	    	$("#divPaging").html("");
	    	str = "";
	    	str += "<div class='col-md-12 stretch-card grid-margin'>";
	    	str += "<div class='card'>";
	    	str += "<div class='card-body'>";
	    	str += "<p class='card-title'>이용 완료 서비스</p>";
	    	str += "<ul class='icon-data-list'>";
	    	$.each(res.content, function(i, v){
	    		str += "<li>";
	    		str += "<div class='d-flex'>";
	    		str += "<img src='"+v.proProflPhoto+"'>";
	    		str += "<div>";
	    		str += "<p class='text-info mb-1'>"+v.userNcnm+"</p>";
	    		str += "<p class='mb-0' onclick=\"location.href='/srvcRequst/srvcRqDetail?srvcRequstNo=" + v.srvcRequstNo + "'\">" +v.srvcRequstSj+"</p>";
	    		str += "<small>"+(v.srvcRequstWrDt).substr(0,10)+"</small>";
	    		str += "</div>";
	    		str += "</div>";
	    		str += "</li>";
	    	});//each 종료
	    	str += "</ul></div></div></div>";
	    	$(".listGrid").html(str);
	    	$("#divPaging").html(res.pagingArea);
        }//success 종료
	});
});


// 작성 리뷰
$("#reviewWrBtn").on("click",function(){
	// 전체 목록
	let currentPage = "${param.currentPage}";
	if(currentPage == ""){
		currentPage = "1";
	}
	
	let size = "5";
	
	let data = {
			"keyword" : "${param.keyword}",
			"currentPage" : currentPage,
			"size" : size
	}
	console.log("기본 리스트 data : ", data);
	
	$.ajax({
		url : "/srvcRqReview/reviewList",
	    contentType : "application/json; charset=utf-8",
	    data : JSON.stringify(data),
	    type : "post",
	    dataType : "json",
	    success : function(res){
	    	console.log("이용완료 res :" , res);
	    	$("#reviewWrCnt").text(res.data.total);
	    	$(".listGrid").html("");
	    	$("#divPaging").html("");
	    	str = "";
	    	str += "<div class='col-md-12 stretch-card grid-margin'>";
	    	str += "<div class='card'>";
	    	str += "<div class='card-body'>";
	    	str += "<p class='card-title'>나의 리뷰</p>";
	    	if(res.reviewNoWrCnt > 0){
	    		str += "<p class='card-description'>작성되지 않은 리뷰가 "+res.reviewNoWrCnt+"건 있습니다.</p>"
	    	}
	    	str += "<ul class='icon-data-list'>";
	    	$.each(res.data.content, function(i, v){
	    		str += "<li>";
	    		str += "<div class='d-flex'>";
	    		str += "<img src='"+v.PRO_PROFL_PHOTO+"'>";
	    		str += "<div>";
	    		str += "<p class='text-info mb-1' onclick=\"location.href='/proProfl/Detail?proId=" + v.PRO_ID + "'\">" + v.USER_NCNM + "</p>";
	    		str += "<button type='button' class='btn btn-inverse-primary btn-sm' onclick=\showReview('"+v.RE_NO+"')\>리뷰 보기</button>"
	    		str += "<p class='mb-0' onclick=\"location.href='/srvcRequst/srvcRqDetail?srvcRequstNo=" + v.SRVC_REQUST_NO + "'\">" +v.SRVC_REQUST_SJ+"</p>";
	    		str += "<small>"+(v.RE_WR_DT)+"</small>";
	    		str += "</div>";
	    		str += "</div>";
	    		str += "</li>";
	    	});//each 종료
	    	str += "</ul></div></div></div>";
	    	$(".listGrid").html(str);
	    	$("#divPaging").html(res.pagingArea);
        }//success 종료
	});// ajax 종료
});// 작성 리뷰 보기 함수 종료

// 리뷰 디테일 보기
function showReview(no){
	console.log("리뷰 디테일 보기");
	$("#showReviewModal").show();
	$("#modalBackdrop").show();
	var reNo = no;
	
	$.ajax({
		url : "/srvcRqReview/showReview?reNo="+reNo,
		type : "post",
		success : function(res){
			console.log("가져온 리뷰 : ", res);
			var reScore = res.reviewVO.reScore
			var reTy = res.reviewVO.reTy;
			var reCn = res.reviewVO.reCn;
			console.log(reTy);
			console.log(reCn);
			console.log(reScore);
			for(i=1; i<reScore+1; i++){
			$(".reScoreVal"+i).addClass("on");
			}
			$.each(res.commonCdDetailVOList, function(i, v){
				if(v.COMMON_CD_DETAIL == reTy){
					reTy = v.COMMON_CD_DETAIL_NM;
					$("#reTy").text(reTy);
				}
			});
			if(reCn != null){
				$("#reCn").css("display", "block");
				$("#reCn").append("<c:out value='"+reCn+"'></c:out>");
			}
		}//success 종료
	});
}
//모달 닫기 함수
function closeModal() {
    $('.star_rating > .star').removeClass('on');
    $('#reTy').val('');
    $('.star_box').val('');
    $("#showReviewModal").hide();
    $("#modalBackdrop").hide();
}

$('.star_rating > .star').click(function() {
    $(this).parent().children('span').removeClass('on');
    $(this).addClass('on').prevAll('span').addClass('on');
});
</script>
<!-- 리뷰 디테일 모달 -->
<div class="modal" id="showReviewModal">
        <h3>내가 쓴 리뷰</h3>
        <p>욕설 및 비방은 관리자에 의해 삭제될 수 있습니다.</p>
        
        <div class ="star_rating">
          <span class="star reScoreVal1" value="1" > </span>
          <span class="star reScoreVal2" value="2"> </span>
          <span class="star reScoreVal3" value="3"> </span>
          <span class="star reScoreVal4" value="4"> </span>
          <span class="star reScoreVal5" value="5"> </span>
        </div>
        
        <div class="form-control" id=reTy style="height: 30px; margin-top: 43px;">
        </div>
        
        <div>
            <pre class="star_box" id="reCn" style="display:none"></pre>
        </div>
        
        <div style="float: right">
            <button type="button" class="btn btn-inverse-secondary btn-sm" onclick="closeModal()" style="margin-top: 10px;">닫기</button>
        </div>
</div>
<div id="modalBackdrop"></div>
