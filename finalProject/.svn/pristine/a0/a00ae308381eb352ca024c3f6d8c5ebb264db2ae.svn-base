<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<script src="/resources/js/jquery.min.js"></script>
<div class="card">
	<div class="card-body">
		<h4 class="card-title">서비스 요청</h4>
		<p class="card-description">
			<div class="dropdown show">
            	<button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuSizeButton3" 
                      	data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"> 선택
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuSizeButton3" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(0px, 31px, 0px);" x-placement="bottom-start">
                	<p class="dropdown-item">닉네임</p>
                    <p class="dropdown-item">제목</p>
                    <p class="dropdown-item">미답변</p>
                    <p class="dropdown-item">답변 완료</p>
                </div>
             </div>
<!-- 			<input type="text" id="searchKeyword"> -->
		</p>
		<div class="table-responsive">
			<table class="table" style="text-align: center;">
				<thead>
					<tr>
						<th>번 호</th>
						<th>문의자 명</th>
						<th>제 목</th>
						<th>진행 상태</th>
						<th>요청 날짜</th>
						<th>완료 여부</th>
					</tr>
				</thead>
				<tbody>
					<c:forEach var="vSrvcRequstVO" items="${vSrvcRequstVOList}" varStatus="status">
						<!-- 회원의 보낸 요청서 목록 -->
						<c:choose>
							<c:when test='${vSrvcRequstVO.emplyrTy.equals("ET02")}'>
								<tr>
								<td>${vSrvcRequstVO.num}</td>
								<td>${vSrvcRequstVO.userNm}</td>
								<td id="srvcRequst${vSrvcRequstVO.srvcRequstNo}" onclick="javascript:srvcRqDetail('${vSrvcRequstVO.srvcRequstNo}','${vSrvcRequstVO.userNm}')">
									${vSrvcRequstVO.srvcRequstSj}</td>
								<c:choose>
									<c:when test="${vSrvcRequstVO.srvcRequstProcessAt eq '1'}">
										<td><label class="badge badge-info">수락</label></td>								
									</c:when>
									<c:when test="${vSrvcRequstVO.srvcRequstProcessAt eq '2'}">
										<td><label class="badge badge-danger">거절</label></td>								
									</c:when>
									<c:otherwise>
										<td><label class="badge badge-secondary">미응답</label></td>								
									</c:otherwise>
								</c:choose>
								<td><fmt:formatDate pattern="yyyy-MM-dd" value="${vSrvcRequstVO.srvcRequstWrDt}"/> </td>
								<td><button type="button" class="btn btn-inverse-secondary btn-fw" id="processAtBtn${vSrvcRequstVO.srvcRequstNo}" 
									onclick="javascript:processAtBtn('${vSrvcRequstVO.srvcRequstNo}','${vSrvcRequstVO.srvcRequstProcessAt}',
																		'${vSrvcRequstVO.srvcRequstProcessMber}','${vSrvcRequstVO.srvcRequstProcessPro}')"></button></td>
							</c:when>
							
							<%-- 프로의 받은 요청서 목록 --%>
							<c:when test='${vSrvcRequstVO.emplyrTy.equals("ET01")}'>
								<tr>
								<td>${vSrvcRequstVO.num}</td>
								<td>${vSrvcRequstVO.userNm}</td>
								<td id="srvcRequst${vSrvcRequstVO.srvcRequstNo}" onclick="javascript:srvcRqDetail('${vSrvcRequstVO.srvcRequstNo}','${vSrvcRequstVO.userNm}')">
									${vSrvcRequstVO.srvcRequstSj}</td>
								<c:choose>
									<c:when test="${vSrvcRequstVO.srvcRequstProcessAt eq '1'}">
										<td><label class="badge badge-info">수락 완료</label></td>								
									</c:when>
									<c:when test="${vSrvcRequstVO.srvcRequstProcessAt eq '2'}">
										<td><label class="badge badge-danger">거절</label></td>								
									</c:when>
									<c:otherwise>
										<td><label class="badge badge-secondary">미응답</label></td>								
									</c:otherwise>
								</c:choose>
								<td><fmt:formatDate pattern="yyyy-MM-dd" value="${vSrvcBtfInqryVO.btfInqryWrDt}"/></td>
								<td><button type="button" class="btn btn-inverse-secondary btn-fw" id="processAtBtn${vSrvcRequstVO.srvcRequstNo}" 
									onclick="javascript:processAtBtn('${vSrvcRequstVO.srvcRequstNo}','${vSrvcRequstVO.srvcRequstProcessAt}',
																		'${vSrvcRequstVO.srvcRequstProcessMber}','${vSrvcRequstVO.srvcRequstProcessPro}')"></button></td>
							</c:when>
						</c:choose>
					</tr>
					</c:forEach>
				</tbody>
			</table>
		</div>
	</div>
</div>
<!-- 상세 모달 -->
<div class="detailModal" >
	<div class="card">
		<div class="card-body">
			<h4 class="card-title">서비스 요청 상세 보기</h4>
			<p class="" id="userNm"></p>
			<p id="srvcRequstWrDt"><p>
			<form class="forms-sample">
				<div class="form-group">
					<label for="srvcRequstSj">제목</label>
					<input type="text" class="form-control" id="srvcRequstSj">
				</div>
				<div class="form-group">
					<label for="srvcRequstCn">내용</label>
					<div class="form-control" id="srvcRequstCn"> 
					</div>
				</div>
<!-- 				<div class="form-group"> -->
<!-- 					<label for="btfInqryAnswerCn">답변</label> -->
<!-- 					<p id="btfInqryAnswerWrDt"></p> -->
<!-- 					<div class="form-control" id="btfInqryAnswerCn"> -->
<!-- 					</div> -->
<!-- 				</div> -->
				<button class="btn btn-light" id="cancelBtn">닫기</button>
			</form>
		</div>
	</div>
</div>
<script>

// 이용완료 버튼
function processAtBtn(no, at, mber, pro){
	
	var srvcRequstNo = no;
	var processAt = at;
	var processMber = mber;
	var processPro = pro;
	
	var data = {
			"srvcRequstNo" : srvcRequstNo,
			"processAt" : processAt,
			"processMber" : processMber,
			"processPro" : processPro
	}
	
	$.ajax({
		url:"/srvcRequst/processFn?srvcRequstNo="+srvcRequstNo,
		contentType : "application/json;charset=utf-8",
		type : "post",
		dataType : "json",
		success : function(res){
			console.log("이용완료 res", res)
			if(res == 1){
				//<button type="button" class="btn btn-inverse-secondary btn-fw" id="processAtBtn" 
				$("#processAtBtn"+srvcRequstNo).attr("class", "btn btn-success btn-rounded");
				$("#processAtBtn"+srvcRequstNo).attr("disabled", true);
				$("#processAtBtn"+srvcRequstNo).text("이용 완료");
			}
		}
	});
}


// 상세 모달 보기 
function srvcRqDetail(no, nm){
	var srvcRequstNo = no;
	var userNm = nm;
	console.log("번호", srvcRequstNo);	
	console.log("닉네임", userNm);	
	
	$.ajax({
		url :"/srvcRequst/srvcRqDetail?srvcRequstNo="+no,
		type : "get",
		contentType : "application/json;charset=utf-8",
		data : {"srvcRequstNo" : srvcRequstNo},
		dataType : "json",
		success : function(res){
			console.log("res", res);
			console.log("제목", res.srvcRequstSj);
			console.log("작성시간 ", res.srvcRequstWrDt);
			// 요청자 닉네임
			$("#userNm").text(userNm);
			// 요청서 작성 시간 
			$("#srvcRequstWrDt").text(res.srvcRequstWrDt);
			// 요청서 제목
			$("#srvcRequstSj").val(res.srvcRequstSj);
			// 요청서 내용
			$("#srvcRequstCn").html(res.srvcRequstCn);	
			},
		error : function(xhr){
				alert("오류 내용 : " + xhr.status);
		}
	});
}

// 닫기 버튼
$("#cancelBtn").on("click", function(){
	
	$("#btfInqrySj").html("");
	$("#btfInqryCn").html("");
	$("#btfInqryAnswerCn").html("");
});
</script>